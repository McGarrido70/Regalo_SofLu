<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>El Universo de Sofi</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        /* --- ESTILOS GENERALES --- */
        body { margin: 0; background-color: #050505; color: white; font-family: 'Segoe UI', sans-serif; overflow-x: hidden; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        /* Contenedor 3D */
        #scene-container {
            width: 85%; height: 400px; margin: 40px auto; position: relative;
            border: 1px solid #333; border-radius: 15px; overflow: hidden;
            box-shadow: 0 0 30px rgba(212, 0, 255, 0.15); cursor: grab;
        }
        #scene-container:active { cursor: grabbing; }
        .instruction { text-align: center; color: #888; font-size: 0.9rem; margin-top: -30px; margin-bottom: 40px; }

        /* Tarjetas */
        .bottom-section { display: flex; justify-content: space-between; width: 85%; margin: 0 auto 50px auto; gap: 20px; }
        .card { background: #0f0f0f; border: 1px solid #222; padding: 25px; width: 48%; border-radius: 15px; }
        h2 { color: #d400ff; margin-top: 0; font-size: 1.4rem; }
        p { line-height: 1.6; color: #ccc; font-size: 0.95rem; }

        /* Calendario */
        .calendar-section { width: 85%; margin: 0 auto 80px auto; background: #0f0f0f; border: 1px solid #222; border-radius: 15px; padding: 20px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-nav { background: #222; color: #d400ff; border: 1px solid #d400ff; padding: 5px 15px; border-radius: 5px; cursor: pointer; }
        .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .day-cell { background: #1a1a1a; padding: 15px; border-radius: 8px; cursor: pointer; position: relative; min-height: 40px; transition: 0.2s; }
        .day-cell.today { border: 1px solid #d400ff; color: #d400ff; font-weight: bold; }
        .has-note::after { content: '‚òÖ'; position: absolute; top: 5px; right: 5px; color: #ffd700; font-size: 0.8rem; animation: spin 3s infinite linear; }
        @keyframes spin { 0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);} }

        /* --- UKELELE INTERACTIVO (NUEVO) --- */
        .uke-section {
            width: 85%; max-width: 500px; margin: 0 auto 120px auto;
            text-align: center; background: #1a1105; /* Color madera oscura */
            padding: 30px; border-radius: 20px; border: 3px solid #3e2710;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.8), 0 0 20px rgba(212, 0, 255, 0.2);
        }
        
        /* Botones de acordes */
        .chord-selectors { display: flex; justify-content: center; gap: 10px; margin-bottom: 25px; flex-wrap: wrap;}
        .chord-btn {
            background: #3e2710; color: #e0c0a0; border: 2px solid #5c3a1d;
            padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold;
            transition: 0.2s;
        }
        .chord-btn.active { background: #d400ff; color: white; border-color: #ff00de; transform: scale(1.1); box-shadow: 0 0 15px #d400ff; }

        /* El diapas√≥n (fretboard) */
        .fretboard {
            position: relative; height: 180px; background: #2a1b0e;
            border-radius: 10px; border: 2px solid #3e2710;
            display: flex; flex-direction: column; justify-content: space-evenly;
            overflow: hidden; cursor: pointer;
             /* Evita seleccionar texto al rasguear r√°pido */
            -webkit-user-select: none; user-select: none;
        }
        
        /* Trastes (l√≠neas verticales) */
        .frets-container { position: absolute; top:0; left:0; width: 100%; height: 100%; pointer-events: none; }
        .fret-line { position: absolute; width: 2px; height: 100%; background: #5c442e; }
        /* Cejilla */
        .nut { position: absolute; left: 0; width: 5px; height: 100%; background: #e0c0a0; z-index: 5; }

        /* Cuerdas (l√≠neas horizontales interactivas) */
        .string {
            position: relative; width: 100%; height: 40px; /* √Årea t√°ctil grande */
            display: flex; align-items: center; z-index: 10;
        }
        /* La l√≠nea visual de la cuerda */
        .string::before {
            content: ''; position: absolute; left: 0; right: 0; height: 2px;
            background: rgba(255,255,255,0.6); box-shadow: 0 1px 2px rgba(0,0,0,0.5);
            transition: 0.1s;
        }
        /* Efecto al vibrar */
        .string.vibrating::before { background: #d400ff; height: 3px; box-shadow: 0 0 10px #d400ff; }

        /* Puntos de los dedos (indicadores de acorde) */
        .finger-dot {
            position: absolute; width: 16px; height: 16px; background: #d400ff;
            border-radius: 50%; box-shadow: 0 0 5px #ff00de; z-index: 20;
            display: none; /* Ocultos por defecto */
            top: 50%; transform: translateY(-50%) translateX(-50%);
        }
        /* Mostrar el punto si la cuerda tiene la clase 'FretX' */
        .string[data-fret="1"] .dot-f1 { display: block; }
        .string[data-fret="2"] .dot-f2 { display: block; }
        .string[data-fret="3"] .dot-f3 { display: block; }


        /* Modal y Player */
        #noteModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: #151515; padding: 30px; border-radius: 10px; width: 300px; border: 1px solid #d400ff; text-align: center; }
        textarea { width: 100%; height: 100px; background: #222; color: white; border: 1px solid #444; margin: 15px 0; border-radius: 5px; padding: 10px; }
        #music-player { position: fixed; bottom: 20px; left: 20px; background: rgba(15, 15, 15, 0.95); border: 1px solid #d400ff; padding: 10px 20px; border-radius: 50px; z-index: 1000; display: flex; align-items: center; gap: 15px; box-shadow: 0 0 15px rgba(212, 0, 255, 0.2); }
        .controls button { background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; }
        .song-info { font-size: 0.85rem; max-width: 120px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #d400ff; }

        @media (max-width: 768px) {
            .bottom-section { flex-direction: column; }
            .card, .calendar-section, .uke-section { width: 90%; box-sizing: border-box; }
            #music-player { left: 5%; width: 80%; justify-content: space-between; }
        }
    </style>
</head>
<body>

    <div id="scene-container"></div>
    <p class="instruction">‚ú® Busca "SOFI" en las estrellas ‚ú®</p>

    <div class="bottom-section">
        <div class="card">
            <h2>Tu Ukelele Virtual</h2>
            <p>Siempre quisiste aprender. Aqu√≠ tienes uno m√°gico para empezar. Es muy f√°cil:</p>
            <p>1. Elige un acorde arriba (ej: 'C' es Do Mayor).</p>
            <p>2. Pasa el mouse o el dedo sobre las cuerdas para rasguear. ¬°Suena de verdad!</p>
        </div>
        <div class="card">
            <h2>Calendario & M√∫sica</h2>
            <p>No olvides dejarme una notita en el calendario de abajo. Se guardan en nuestra nube.</p>
            <p>Dale play a la m√∫sica para inspirarte mientras tocas.</p>
        </div>
    </div>

    <div class="calendar-section">
        <div class="calendar-header">
            <button class="btn-nav" onclick="changeMonth(-1)">‚ùÆ</button>
            <h3 id="monthYear"></h3>
            <button class="btn-nav" onclick="changeMonth(1)">‚ùØ</button>
        </div>
        <div class="days-grid" id="calendarGrid"></div>
    </div>

    <div class="uke-section">
        <h2>Ukelele C√≥smico üéµ</h2>
        
        <div class="chord-selectors">
            <button class="chord-btn active" onclick="setChord('C')">C (Do)</button>
            <button class="chord-btn" onclick="setChord('G')">G (Sol)</button>
            <button class="chord-btn" onclick="setChord('Am')">Am (La Menor)</button>
            <button class="chord-btn" onclick="setChord('F')">F (Fa)</button>
        </div>

        <div class="fretboard" id="fretboardArea">
            <div class="nut"></div>
            <div class="frets-container">
                <div class="fret-line" style="left: 25%;"></div>
                <div class="fret-line" style="left: 50%;"></div>
                <div class="fret-line" style="left: 75%;"></div>
            </div>

            <div class="string" data-string-idx="3" data-fret="0">
                <div class="finger-dot dot-f1" style="left: 12.5%;"></div>
                <div class="finger-dot dot-f2" style="left: 37.5%;"></div>
                <div class="finger-dot dot-f3" style="left: 62.5%;"></div>
            </div>
            <div class="string" data-string-idx="2" data-fret="0">
                <div class="finger-dot dot-f1" style="left: 12.5%;"></div>
                <div class="finger-dot dot-f2" style="left: 37.5%;"></div>
                <div class="finger-dot dot-f3" style="left: 62.5%;"></div>
            </div>
            <div class="string" data-string-idx="1" data-fret="0">
                <div class="finger-dot dot-f1" style="left: 12.5%;"></div>
                <div class="finger-dot dot-f2" style="left: 37.5%;"></div>
                <div class="finger-dot dot-f3" style="left: 62.5%;"></div>
            </div>
            <div class="string" data-string-idx="0" data-fret="0">
                <div class="finger-dot dot-f1" style="left: 12.5%;"></div>
                <div class="finger-dot dot-f2" style="left: 37.5%;"></div>
                <div class="finger-dot dot-f3" style="left: 62.5%;"></div>
            </div>
        </div>
    </div>

    <div id="noteModal">
        <div class="modal-content">
            <h3 id="modalDateTitle">Fecha</h3>
            <textarea id="noteText" placeholder="Escribe un mensaje para nosotros..."></textarea>
            <div>
                <button class="btn-nav" onclick="closeModal()">Cerrar</button>
                <button class="btn-nav" style="background:#d400ff; color:white;" onclick="saveNote()">Guardar en la Nube ‚òÅÔ∏è</button>
            </div>
        </div>
    </div>

    <div id="music-player">
        <div class="song-info"><span id="songTitle">Elige canci√≥n...</span></div>
        <div class="controls">
            <button onclick="prevSong()">‚èÆ</button>
            <button onclick="togglePlay()" id="playBtn">‚ñ∂</button>
            <button onclick="nextSong()">‚è≠</button>
        </div>
        <audio id="audioPlayer"></audio>
    </div>

    <script>
        // --- 1. FIREBASE (MANTIENE TU CONFIGURACI√ìN AL FINAL) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCvzZNhb97ABzhKalhPppHwcfUMG5lGVyg",
            authDomain: "regalo-sofi-31bd7.firebaseapp.com",
            databaseURL: "https://regalo-sofi-31bd7-default-rtdb.firebaseio.com",
            projectId: "regalo-sofi-31bd7",
            storageBucket: "regalo-sofi-31bd7.firebasestorage.app",
            messagingSenderId: "896831826087",
            appId: "1:896831826087:web:d9a067f38828a5c1eb1382"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const database = firebase.database();


        // --- 2. L√ìGICA DEL UKELELE (NUEVO & MEJORADO) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        // Afinaci√≥n est√°ndar ukelele (G4, C4, E4, A4) - Re-entrant
        const openStrings = [392.00, 261.63, 329.63, 440.00]; 
        
        // Mapa de acordes: [cuerda4, cuerda3, cuerda2, cuerda1] (Traste a pisar)
        const chordShapes = {
            'C':  [0, 0, 0, 3],
            'G':  [0, 2, 3, 2],
            'Am': [2, 0, 0, 0],
            'F':  [2, 0, 1, 0]
        };
        let currentChord = 'C'; // Acorde inicial

        // Funci√≥n para cambiar el acorde activo
        function setChord(chordName) {
            currentChord = chordName;
            // Actualizar botones visualmente
            document.querySelectorAll('.chord-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Actualizar puntos en el diapas√≥n
            const shape = chordShapes[chordName];
            const stringElements = document.querySelectorAll('.string');
            // Invertimos el orden porque en HTML la cuerda 0 (G) es la √∫ltima visualmente
            shape.forEach((fret, idx) => {
                // Mapeo: idx 0 -> string 3 (G), idx 1 -> string 2 (C)...
                const htmlStringIdx = 3 - idx; 
                stringElements[htmlStringIdx].setAttribute('data-fret', fret);
            });
        }

        // Inicializar con Do Mayor
        setChord('C');

        // SINTETIZADOR DE CUERDA DE NAILON (Suave)
        function pluckString(stringIdx) {
            // 1. Calcular frecuencia seg√∫n el traste pisado actualmente
            const stringEl = document.querySelector(`.string[data-string-idx="${stringIdx}"]`);
            const fret = parseInt(stringEl.getAttribute('data-fret'));
            const frequency = openStrings[3 - stringIdx] * Math.pow(2, fret / 12); // 3-idx para ajustar al orden del array
            
            // 2. Efecto visual de vibraci√≥n
            stringEl.classList.add('vibrating');
            setTimeout(() => stringEl.classList.remove('vibrating'), 200);

            // 3. Generar sonido
            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            const filter = audioCtx.createBiquadFilter();

            // Usamos onda triangular para un sonido m√°s dulce (tipo flauta/nailon)
            osc.type = 'triangle';
            osc.frequency.value = frequency;

            // Filtro pasa-bajos para quitar el brillo digital
            filter.type = 'lowpass';
            filter.frequency.value = 3000;

            // Envolvente (C√≥mo empieza y termina el sonido)
            gainNode.gain.setValueAtTime(0, now);
            gainNode.gain.linearRampToValueAtTime(0.6, now + 0.01); // Ataque r√°pido (el pellizco)
            gainNode.gain.exponentialRampToValueAtTime(0.001, now + 1.5); // Decaimiento largo

            osc.connect(filter);
            filter.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            osc.start(now);
            osc.stop(now + 1.5);
        }

        // MANEJO DE INTERACCI√ìN (Rasgueo y Arpegio)
        const fretboard = document.getElementById('fretboardArea');
        let isStrumming = false;

        // Detectar inicio de interacci√≥n (Mouse o T√°ctil)
        fretboard.addEventListener('mousedown', () => isStrumming = true);
        fretboard.addEventListener('touchstart', () => isStrumming = true, {passive: true});
        
        // Detectar fin de interacci√≥n
        window.addEventListener('mouseup', () => isStrumming = false);
        window.addEventListener('touchend', () => isStrumming = false);

        const strings = document.querySelectorAll('.string');
        strings.forEach(str => {
            const idx = parseInt(str.getAttribute('data-string-idx'));
            
            // Arpegio: Clic o toque simple en una cuerda
            str.addEventListener('mousedown', () => pluckString(idx));
            
            // Rasgueo: Pasar el mouse por encima mientras se hace clic
            str.addEventListener('mouseenter', () => {
                if(isStrumming) pluckString(idx);
            });

             // Rasgueo T√°ctil (M√°s complejo, detectamos movimiento del dedo)
            str.addEventListener('touchmove', (e) => {
                // Evitar que suene m√∫ltiples veces en el mismo "movimiento" sobre la misma cuerda
                if(isStrumming && !str.classList.contains('vibrating')) {
                     // Verificar si el toque realmente est√° sobre esta cuerda
                    const touch = e.touches[0];
                    const rect = str.getBoundingClientRect();
                    if(touch.clientY >= rect.top && touch.clientY <= rect.bottom) {
                         pluckString(idx);
                    }
                }
            }, {passive: true});
        });


        // --- 3. CALENDARIO CONECTADO (SE MANTIENE IGUAL) ---
        let currentDate = new Date();
        const monthYearEl = document.getElementById('monthYear');
        const calendarGrid = document.getElementById('calendarGrid');
        const modal = document.getElementById('noteModal');
        const noteText = document.getElementById('noteText');
        let selectedDateKey = null;
        let allNotes = {};

        const notesRef = database.ref('calendario_notas');
        notesRef.on('value', (snapshot) => {
            allNotes = snapshot.val() || {};
            renderCalendar();
        });

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            monthYearEl.innerText = new Date(year, month).toLocaleString('es-ES', { month: 'long', year: 'numeric' });
            calendarGrid.innerHTML = '';
            
            ['D','L','M','X','J','V','S'].forEach(day => {
                const div = document.createElement('div'); div.style.color='#888'; div.innerText = day; calendarGrid.appendChild(div);
            });

            const firstDayIndex = new Date(year, month, 1).getDay();
            for(let i=0; i<firstDayIndex; i++) calendarGrid.appendChild(document.createElement('div'));

            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();

            for(let i=1; i<=daysInMonth; i++){
                const dayEl = document.createElement('div'); dayEl.className = 'day-cell'; dayEl.innerText = i;
                const dateKey = `${i}-${month}-${year}`;
                if(i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) dayEl.classList.add('today');
                if(allNotes[dateKey]) dayEl.classList.add('has-note');
                dayEl.onclick = () => openModal(i, month, year);
                calendarGrid.appendChild(dayEl);
            }
        }
        function changeMonth(d) { currentDate.setMonth(currentDate.getMonth() + d); renderCalendar(); }
        function openModal(d, m, y) {
            selectedDateKey = `${d}-${m}-${y}`;
            document.getElementById('modalDateTitle').innerText = `${d}/${m+1}/${y}`;
            noteText.value = allNotes[selectedDateKey] || '';
            modal.style.display = 'flex';
        }
        function closeModal() { modal.style.display = 'none'; }
        function saveNote() {
            const val = noteText.value.trim();
            if(val==="") database.ref('calendario_notas/'+selectedDateKey).remove();
            else database.ref('calendario_notas/'+selectedDateKey).set(val);
            closeModal();
        }

        // --- 4. PLAYER DE M√öSICA (SE MANTIENE IGUAL) ---
        const playlist = [ { title: "Canci√≥n 1", file: "cancion1.mp3" }, { title: "Canci√≥n 2", file: "cancion2.mp3" } ];
        let currentSongIndex = 0;
        const audioPlayer = document.getElementById('audioPlayer');
        const playBtn = document.getElementById('playBtn');
        const titleLabel = document.getElementById('songTitle');
        let isPlaying = false;
        function loadSong(index) { if(playlist.length) { audioPlayer.src = playlist[index].file; titleLabel.innerText = playlist[index].title; } }
        function togglePlay() {
            if(!playlist.length) return alert("¬°Recuerda subir tus canciones!");
            if(!audioPlayer.src) loadSong(0);
            if(isPlaying) { audioPlayer.pause(); playBtn.innerText="‚ñ∂"; } else { audioPlayer.play(); playBtn.innerText="‚è∏"; }
            isPlaying = !isPlaying;
        }
        function nextSong() { currentSongIndex=(currentSongIndex+1)%playlist.length; loadSong(currentSongIndex); if(isPlaying) audioPlayer.play(); }
        function prevSong() { currentSongIndex=(currentSongIndex-1+playlist.length)%playlist.length; loadSong(currentSongIndex); if(isPlaying) audioPlayer.play(); }

        // --- 5. 3D SOFI (SE MANTIENE IGUAL) ---
        let camera, scene, renderer, controls, wordGroup;
        const container = document.getElementById('scene-container');
        init(); animate();
        function init() {
            scene = new THREE.Scene(); scene.fog = new THREE.FogExp2(0x000000, 0.0015);
            camera = new THREE.PerspectiveCamera(60, container.clientWidth/container.clientHeight, 0.1, 2000); camera.position.z = 500;
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true }); renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);
            controls = new THREE.OrbitControls(camera, renderer.domElement); controls.enableDamping=true; controls.enableZoom=false;
            const sg = new THREE.BufferGeometry(); const sp = [];
            for(let i=0; i<3000; i++) sp.push(THREE.MathUtils.randFloatSpread(2000), THREE.MathUtils.randFloatSpread(2000), THREE.MathUtils.randFloatSpread(2000));
            sg.setAttribute('position', new THREE.Float32BufferAttribute(sp, 3));
            scene.add(new THREE.Points(sg, new THREE.PointsMaterial({color:0x888888, size:1.5})));
            createSofi();
            window.addEventListener('resize', ()=>{ camera.aspect=container.clientWidth/container.clientHeight; camera.updateProjectionMatrix(); renderer.setSize(container.clientWidth, container.clientHeight); });
        }
        function createSofi() {
            wordGroup = new THREE.Group();
            const ml = new THREE.LineBasicMaterial({color:0xd400ff, opacity:0.8, transparent:true});
            const md = new THREE.PointsMaterial({color:0xffffff, size:4});
            function al(pts, x) {
                const g = new THREE.BufferGeometry().setFromPoints(pts);
                const l = new THREE.Line(g, ml); l.position.x=x;
                const s = new THREE.Points(g, md); s.position.x=x;
                wordGroup.add(l,s);
            }
            const h=40, w=30;
            al([new THREE.Vector3(w,h,0),new THREE.Vector3(0,h,0),new THREE.Vector3(0,0,0),new THREE.Vector3(w,0,0),new THREE.Vector3(w,-h,0),new THREE.Vector3(0,-h,0)], -80);
            al([new THREE.Vector3(0,h,0),new THREE.Vector3(w,h,0),new THREE.Vector3(w,-h,0),new THREE.Vector3(0,-h,0),new THREE.Vector3(0,h,0)], -30);
            al([new THREE.Vector3(w,h,0),new THREE.Vector3(0,h,0),new THREE.Vector3(0,-h,0)], 20); al([new THREE.Vector3(0,0,0),new THREE.Vector3(w*0.7,0,0)], 20);
            al([new THREE.Vector3(0,h,0),new THREE.Vector3(0,-h,0)], 70);
            wordGroup.rotation.set(Math.random()*6, Math.random()*6, Math.random()*6);
            wordGroup.position.set(Math.random()*400-200, Math.random()*400-200, Math.random()*400-200);
            scene.add(wordGroup);
        }
        function animate() { requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); }
    </script>
</body>
</html>
