<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>El Universo de Sofi</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        /* --- ESTILOS GENERALES --- */
        body { margin: 0; background-color: #050505; color: white; font-family: 'Segoe UI', sans-serif; overflow-x: hidden; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        /* Contenedor 3D */
        #scene-container {
            width: 85%; height: 400px; margin: 40px auto; position: relative;
            border: 1px solid #333; border-radius: 15px; overflow: hidden;
            box-shadow: 0 0 30px rgba(212, 0, 255, 0.15); cursor: grab;
        }
        #scene-container:active { cursor: grabbing; }
        .instruction { text-align: center; color: #888; font-size: 0.9rem; margin-top: -30px; margin-bottom: 40px; }

        /* Tarjetas */
        .bottom-section { display: flex; justify-content: space-between; width: 85%; margin: 0 auto 50px auto; gap: 20px; }
        .card { background: #0f0f0f; border: 1px solid #222; padding: 25px; width: 48%; border-radius: 15px; }
        h2 { color: #d400ff; margin-top: 0; font-size: 1.4rem; }
        p { line-height: 1.6; color: #ccc; font-size: 0.95rem; }

        /* Calendario */
        .calendar-section { width: 85%; margin: 0 auto 80px auto; background: #0f0f0f; border: 1px solid #222; border-radius: 15px; padding: 20px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-nav { background: #222; color: #d400ff; border: 1px solid #d400ff; padding: 5px 15px; border-radius: 5px; cursor: pointer; }
        .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .day-cell { background: #1a1a1a; padding: 15px; border-radius: 8px; cursor: pointer; position: relative; min-height: 40px; transition: 0.2s; }
        .day-cell.today { border: 1px solid #d400ff; color: #d400ff; font-weight: bold; }
        .has-note::after { content: '‚òÖ'; position: absolute; top: 5px; right: 5px; color: #ffd700; font-size: 0.8rem; animation: spin 3s infinite linear; }
        @keyframes spin { 0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);} }

        /* --- GUITARRA C√ìSMICA (NUEVO) --- */
        .guitar-section {
            width: 85%; margin: 0 auto 120px auto;
            text-align: center;
            background: linear-gradient(180deg, #1a0b2e 0%, #0f0f0f 100%);
            padding: 30px; border-radius: 15px; border: 1px solid #d400ff;
            box-shadow: inset 0 0 20px rgba(212, 0, 255, 0.2);
        }
        
        .chord-display {
            height: 60px; margin-bottom: 20px;
            display: flex; justify-content: center; align-items: center;
        }
        #active-chord-name {
            font-size: 2.5rem; color: #d400ff; font-weight: bold;
            text-shadow: 0 0 15px #d400ff, 0 0 30px #00ffff;
            opacity: 0; transition: opacity 0.3s;
        }
        
        .chord-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px; margin-top: 20px;
        }
        
        .chord-btn {
            background: rgba(20,20,20,0.8); border: 2px solid #555;
            color: white; padding: 20px 10px; border-radius: 10px;
            font-size: 1.2rem; cursor: pointer; position: relative;
            transition: all 0.2s; overflow: hidden;
        }
        
        /* Efecto al tocar el acorde */
        .chord-btn.playing {
            border-color: #00ffff; background: rgba(0, 255, 255, 0.1);
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.5);
            transform: scale(0.95); color: #00ffff;
        }
        
        /* Peque√±a ayuda visual de las cuerdas */
        .chord-btn::before {
            content: '‚ùö ‚ùö ‚ùö ‚ùö ‚ùö ‚ùö'; position: absolute;
            bottom: 5px; left: 0; width: 100%; color: #333; font-size: 0.6rem;
            letter-spacing: 3px; opacity: 0.5;
        }
        .chord-btn.playing::before { color: #d400ff; opacity: 1; }

        /* Subt√≠tulo del acorde (Mayor/Menor) */
        .chord-sub { display: block; font-size: 0.7rem; color: #aaa; margin-top: 5px; }


        /* Modal y Player */
        #noteModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: #151515; padding: 30px; border-radius: 10px; width: 300px; border: 1px solid #d400ff; text-align: center; }
        textarea { width: 100%; height: 100px; background: #222; color: white; border: 1px solid #444; margin: 15px 0; border-radius: 5px; padding: 10px; }
        
        #music-player { position: fixed; bottom: 20px; left: 20px; background: rgba(15, 15, 15, 0.95); border: 1px solid #d400ff; padding: 10px 20px; border-radius: 50px; z-index: 1000; display: flex; align-items: center; gap: 15px; box-shadow: 0 0 15px rgba(212, 0, 255, 0.2); }
        .controls button { background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; }
        .song-info { font-size: 0.85rem; max-width: 120px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #d400ff; }

        @media (max-width: 768px) {
            .bottom-section { flex-direction: column; }
            .card, .calendar-section, .guitar-section { width: 90%; box-sizing: border-box; }
            .chord-grid { grid-template-columns: repeat(2, 1fr); } /* 2 columnas en celular */
            #music-player { left: 5%; width: 80%; justify-content: space-between; }
        }
    </style>
</head>
<body>

    <div id="scene-container"></div>
    <p class="instruction">‚ú® Busca "SOFI" en las estrellas ‚ú®</p>

    <div class="bottom-section">
        <div class="card">
            <h2>Hola Sofi</h2>
            <p>S√© que siempre has querido aprender guitarra. Este es tu primer paso en el universo de la m√∫sica.</p>
            <p>Aqu√≠ abajo tienes una guitarra c√≥smica. Toca los botones para rasguear tus primeros acordes reales.</p>
        </div>
        <div class="card">
            <h2>Instrucciones</h2>
            <p>üé∏ <b>Guitarra:</b> Haz clic en los botones de acordes (C, G, D...) para escuchar c√≥mo suenan.</p>
            <p>üìÖ <b>Calendario:</b> Anota nuestros momentos en la nube.</p>
            <p>üéµ <b>M√∫sica:</b> Dale play para inspirarte.</p>
        </div>
    </div>

    <div class="calendar-section">
        <div class="calendar-header">
            <button class="btn-nav" onclick="changeMonth(-1)">‚ùÆ</button>
            <h3 id="monthYear"></h3>
            <button class="btn-nav" onclick="changeMonth(1)">‚ùØ</button>
        </div>
        <div class="days-grid" id="calendarGrid"></div>
    </div>

    <div class="guitar-section">
        <h2>üé∏ Acordes C√≥smicos</h2>
        <div class="chord-display">
            <span id="active-chord-name"></span>
        </div>
        
        <div class="chord-grid">
            <button class="chord-btn" onclick="playChord('C')">C <span class="chord-sub">Do Mayor</span></button>
            <button class="chord-btn" onclick="playChord('G')">G <span class="chord-sub">Sol Mayor</span></button>
            <button class="chord-btn" onclick="playChord('D')">D <span class="chord-sub">Re Mayor</span></button>
            <button class="chord-btn" onclick="playChord('A')">A <span class="chord-sub">La Mayor</span></button>
            <button class="chord-btn" onclick="playChord('E')">E <span class="chord-sub">Mi Mayor</span></button>
            <button class="chord-btn" onclick="playChord('Am')">Am <span class="chord-sub">La Menor</span></button>
            <button class="chord-btn" onclick="playChord('Em')">Em <span class="chord-sub">Mi Menor</span></button>
            <button class="chord-btn" onclick="playChord('Dm')">Dm <span class="chord-sub">Re Menor</span></button>
        </div>
    </div>

    <div id="noteModal">
        <div class="modal-content">
            <h3 id="modalDateTitle">Fecha</h3>
            <textarea id="noteText" placeholder="Escribe un mensaje para nosotros..."></textarea>
            <div>
                <button class="btn-nav" onclick="closeModal()">Cerrar</button>
                <button class="btn-nav" style="background:#d400ff; color:white;" onclick="saveNote()">Guardar en la Nube ‚òÅÔ∏è</button>
            </div>
        </div>
    </div>

    <div id="music-player">
        <div class="song-info"><span id="songTitle">Elige canci√≥n...</span></div>
        <div class="controls">
            <button onclick="prevSong()">‚èÆ</button>
            <button onclick="togglePlay()" id="playBtn">‚ñ∂</button>
            <button onclick="nextSong()">‚è≠</button>
        </div>
        <audio id="audioPlayer"></audio>
    </div>

    <script>
        // --- 1. FIREBASE (SE MANTIENE IGUAL) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCvzZNhb97ABzhKalhPppHwcfUMG5lGVyg",
            authDomain: "regalo-sofi-31bd7.firebaseapp.com",
            databaseURL: "https://regalo-sofi-31bd7-default-rtdb.firebaseio.com",
            projectId: "regalo-sofi-31bd7",
            storageBucket: "regalo-sofi-31bd7.firebasestorage.app",
            messagingSenderId: "896831826087",
            appId: "1:896831826087:web:d9a067f38828a5c1eb1382"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const database = firebase.database();


        // --- 2. L√ìGICA DE LA GUITARRA C√ìSMICA (NUEVO) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const chordDisplay = document.getElementById('active-chord-name');
        let displayTimeout;

        // Definici√≥n de los acordes (Qu√© trastes se pisan en las 6 cuerdas: E A D G B E)
        // -1 significa que la cuerda no se toca (mute)
        const chords = {
            'C':  [-1, 3, 2, 0, 1, 0], // Do Mayor
            'G':  [3, 2, 0, 0, 0, 3],  // Sol Mayor
            'D':  [-1, -1, 0, 2, 3, 2], // Re Mayor
            'A':  [-1, 0, 2, 2, 2, 0], // La Mayor
            'E':  [0, 2, 2, 1, 0, 0],  // Mi Mayor
            'Am': [-1, 0, 2, 2, 1, 0], // La Menor
            'Em': [0, 2, 2, 0, 0, 0],  // Mi Menor
            'Dm': [-1, -1, 0, 2, 3, 1] // Re Menor
        };

        // Frecuencias base de las cuerdas al aire (Afinaci√≥n Est√°ndar)
        const baseTuning = [82.41, 110.00, 146.83, 196.00, 246.94, 329.63];

        function playChord(chordName) {
            // 1. Efectos visuales
            const btn = event.currentTarget;
            btn.classList.add('playing');
            setTimeout(() => btn.classList.remove('playing'), 300);
            
            chordDisplay.innerText = chordName;
            chordDisplay.style.opacity = 1;
            clearTimeout(displayTimeout);
            displayTimeout = setTimeout(() => chordDisplay.style.opacity = 0, 2000);

            // 2. Generar sonido (Rasgueo)
            const fretPositions = chords[chordName];
            const now = audioCtx.currentTime;

            fretPositions.forEach((fret, stringIndex) => {
                if (fret >= 0) {
                    // Calcular la frecuencia de la nota exacta basada en el traste
                    // F√≥rmula: FrecuenciaBase * 2^(traste/12)
                    let frequency = baseTuning[stringIndex] * Math.pow(2, fret / 12);
                    
                    // Reproducir la cuerda con un peque√±o retraso (efecto rasgueo)
                    // Las cuerdas graves suenan primero, las agudas un poco despu√©s
                    playString(frequency, now + (stringIndex * 0.04)); 
                }
            });
        }

        // Sintetizador de cuerda de guitarra
        function playString(freq, time) {
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            // Usamos onda "sawtooth" filtrada para un sonido m√°s met√°lico/cuerda
            osc.type = 'sawtooth'; 
            osc.frequency.value = freq;

            // Filtro para suavizar el sonido met√°lico
            const filter = audioCtx.createBiquadFilter();
            filter.type = "lowpass";
            filter.frequency.value = 2000; // Cortar frecuencias muy agudas

            osc.connect(filter);
            filter.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            // Envolvente de sonido (Attack r√°pido, Decay largo como una cuerda)
            gainNode.gain.setValueAtTime(0, time);
            gainNode.gain.linearRampToValueAtTime(0.4, time + 0.02); // Ataque r√°pido
            gainNode.gain.exponentialRampToValueAtTime(0.001, time + 2); // Se apaga lentamente

            osc.start(time);
            osc.stop(time + 2); // Detener despu√©s de 2 segundos
        }


        // --- 3. CALENDARIO CONECTADO (SE MANTIENE IGUAL) ---
        let currentDate = new Date();
        const monthYearEl = document.getElementById('monthYear');
        const calendarGrid = document.getElementById('calendarGrid');
        const modal = document.getElementById('noteModal');
        const noteText = document.getElementById('noteText');
        let selectedDateKey = null;
        let allNotes = {};

        const notesRef = database.ref('calendario_notas');
        notesRef.on('value', (snapshot) => {
            allNotes = snapshot.val() || {};
            renderCalendar();
        });

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            monthYearEl.innerText = new Date(year, month).toLocaleString('es-ES', { month: 'long', year: 'numeric' });
            calendarGrid.innerHTML = '';
            
            ['D','L','M','X','J','V','S'].forEach(day => {
                const div = document.createElement('div'); div.style.color='#888'; div.innerText = day; calendarGrid.appendChild(div);
            });

            const firstDayIndex = new Date(year, month, 1).getDay();
            for(let i=0; i<firstDayIndex; i++) calendarGrid.appendChild(document.createElement('div'));

            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();

            for(let i=1; i<=daysInMonth; i++){
                const dayEl = document.createElement('div'); dayEl.className = 'day-cell'; dayEl.innerText = i;
                const dateKey = `${i}-${month}-${year}`;
                if(i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) dayEl.classList.add('today');
                if(allNotes[dateKey]) dayEl.classList.add('has-note');
                dayEl.onclick = () => openModal(i, month, year);
                calendarGrid.appendChild(dayEl);
            }
        }
        function changeMonth(d) { currentDate.setMonth(currentDate.getMonth() + d); renderCalendar(); }
        function openModal(d, m, y) {
            selectedDateKey = `${d}-${m}-${y}`;
            document.getElementById('modalDateTitle').innerText = `${d}/${m+1}/${y}`;
            noteText.value = allNotes[selectedDateKey] || '';
            modal.style.display = 'flex';
        }
        function closeModal() { modal.style.display = 'none'; }
        function saveNote() {
            const val = noteText.value.trim();
            if(val==="") database.ref('calendario_notas/'+selectedDateKey).remove();
            else database.ref('calendario_notas/'+selectedDateKey).set(val);
            closeModal();
        }

        // --- 4. PLAYER DE M√öSICA (SE MANTIENE IGUAL) ---
        const playlist = [ { title: "Canci√≥n 1", file: "cancion1.mp3" }, { title: "Canci√≥n 2", file: "cancion2.mp3" } ];
        let currentSongIndex = 0;
        const audioPlayer = document.getElementById('audioPlayer');
        const playBtn = document.getElementById('playBtn');
        const titleLabel = document.getElementById('songTitle');
        let isPlaying = false;
        function loadSong(index) { if(playlist.length) { audioPlayer.src = playlist[index].file; titleLabel.innerText = playlist[index].title; } }
        function togglePlay() {
            if(!playlist.length) return alert("¬°Recuerda subir tus canciones!");
            if(!audioPlayer.src) loadSong(0);
            if(isPlaying) { audioPlayer.pause(); playBtn.innerText="‚ñ∂"; } else { audioPlayer.play(); playBtn.innerText="‚è∏"; }
            isPlaying = !isPlaying;
        }
        function nextSong() { currentSongIndex=(currentSongIndex+1)%playlist.length; loadSong(currentSongIndex); if(isPlaying) audioPlayer.play(); }
        function prevSong() { currentSongIndex=(currentSongIndex-1+playlist.length)%playlist.length; loadSong(currentSongIndex); if(isPlaying) audioPlayer.play(); }

        // --- 5. 3D SOFI (SE MANTIENE IGUAL) ---
        let camera, scene, renderer, controls, wordGroup;
        const container = document.getElementById('scene-container');
        init(); animate();
        function init() {
            scene = new THREE.Scene(); scene.fog = new THREE.FogExp2(0x000000, 0.0015);
            camera = new THREE.PerspectiveCamera(60, container.clientWidth/container.clientHeight, 0.1, 2000); camera.position.z = 500;
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true }); renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);
            controls = new THREE.OrbitControls(camera, renderer.domElement); controls.enableDamping=true; controls.enableZoom=false;
            const sg = new THREE.BufferGeometry(); const sp = [];
            for(let i=0; i<3000; i++) sp.push(THREE.MathUtils.randFloatSpread(2000), THREE.MathUtils.randFloatSpread(2000), THREE.MathUtils.randFloatSpread(2000));
            sg.setAttribute('position', new THREE.Float32BufferAttribute(sp, 3));
            scene.add(new THREE.Points(sg, new THREE.PointsMaterial({color:0x888888, size:1.5})));
            createSofi();
            window.addEventListener('resize', ()=>{ camera.aspect=container.clientWidth/container.clientHeight; camera.updateProjectionMatrix(); renderer.setSize(container.clientWidth, container.clientHeight); });
        }
        function createSofi() {
            wordGroup = new THREE.Group();
            const ml = new THREE.LineBasicMaterial({color:0xd400ff, opacity:0.8, transparent:true});
            const md = new THREE.PointsMaterial({color:0xffffff, size:4});
            function al(pts, x) {
                const g = new THREE.BufferGeometry().setFromPoints(pts);
                const l = new THREE.Line(g, ml); l.position.x=x;
                const s = new THREE.Points(g, md); s.position.x=x;
                wordGroup.add(l,s);
            }
            const h=40, w=30;
            al([new THREE.Vector3(w,h,0),new THREE.Vector3(0,h,0),new THREE.Vector3(0,0,0),new THREE.Vector3(w,0,0),new THREE.Vector3(w,-h,0),new THREE.Vector3(0,-h,0)], -80);
            al([new THREE.Vector3(0,h,0),new THREE.Vector3(w,h,0),new THREE.Vector3(w,-h,0),new THREE.Vector3(0,-h,0),new THREE.Vector3(0,h,0)], -30);
            al([new THREE.Vector3(w,h,0),new THREE.Vector3(0,h,0),new THREE.Vector3(0,-h,0)], 20); al([new THREE.Vector3(0,0,0),new THREE.Vector3(w*0.7,0,0)], 20);
            al([new THREE.Vector3(0,h,0),new THREE.Vector3(0,-h,0)], 70);
            wordGroup.rotation.set(Math.random()*6, Math.random()*6, Math.random()*6);
            wordGroup.position.set(Math.random()*400-200, Math.random()*400-200, Math.random()*400-200);
            scene.add(wordGroup);
        }
        function animate() { requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); }
    </script>
</body>
</html>
