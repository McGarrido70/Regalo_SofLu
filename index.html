<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>El Universo de Sofi</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        /* --- ESTILOS GENERALES --- */
        body { margin: 0; background-color: #050505; color: white; font-family: 'Segoe UI', sans-serif; overflow-x: hidden; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        #start-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 5000; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 1s; }
        #start-btn { padding: 15px 40px; font-size: 1.5rem; background: transparent; color: #d400ff; border: 2px solid #d400ff; border-radius: 50px; cursor: pointer; transition: 0.3s; box-shadow: 0 0 20px rgba(212, 0, 255, 0.4); }

        /* CONTENEDOR 3D */
        #scene-container { width: 95%; height: 350px; margin: 20px auto; position: relative; border: 1px solid #333; border-radius: 15px; overflow: hidden; box-shadow: 0 0 30px rgba(212, 0, 255, 0.15); cursor: grab; }
        .instruction { text-align: center; color: #888; font-size: 0.8rem; margin-top: -15px; margin-bottom: 30px; }

        /* SECCIONES Y TARJETAS */
        .bottom-section { display: flex; justify-content: space-between; width: 95%; margin: 0 auto 50px auto; gap: 15px; flex-wrap: wrap;}
        .card { background: #0f0f0f; border: 1px solid #222; padding: 20px; width: 45%; border-radius: 15px; min-width: 300px; flex-grow: 1; }
        h2 { color: #d400ff; margin-top: 0; font-size: 1.2rem; }
        p { line-height: 1.5; color: #ccc; font-size: 0.9rem; }

        /* CALENDARIO */
        .calendar-section { width: 95%; margin: 0 auto 80px auto; background: #0f0f0f; border: 1px solid #222; border-radius: 15px; padding: 20px; text-align: center;}
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-nav { background: #222; color: #d400ff; border: 1px solid #d400ff; padding: 5px 15px; border-radius: 5px; cursor: pointer; }
        .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .day-cell { background: #1a1a1a; padding: 10px; border-radius: 5px; cursor: pointer; min-height: 40px; position: relative;}
        .day-cell.today { border: 1px solid #d400ff; color: #d400ff; font-weight: bold;}
        .has-note::after { content: '‚òÖ'; position: absolute; top: 2px; right: 2px; color: #ffd700; font-size: 0.7rem; }

        /* UKELELE */
        .uke-section { width: 95%; max-width: 550px; margin: 0 auto 80px auto; text-align: center; background: #2a1b0e; padding: 15px; border-radius: 20px; border: 3px solid #4a3018; touch-action: none; }
        .chord-selectors { display: flex; justify-content: center; gap: 5px; margin-bottom: 15px; flex-wrap: wrap; }
        .chord-btn { background: #4a3018; color: #dcb; border: 1px solid #6b4c2e; padding: 8px 10px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; }
        .chord-btn.active { background: #d400ff; color: white; border-color: #fff; }
        .fretboard { position: relative; height: 160px; background: linear-gradient(to bottom, #2c1e12, #1a0b05); border: 2px solid #4a3018; border-radius: 8px; display: flex; flex-direction: column; justify-content: space-evenly; overflow: hidden; }
        .fret-line { position: absolute; top:0; height:100%; width:2px; background:#553a22; }
        .string { position: relative; width: 100%; height: 40px; display: flex; align-items: center; z-index: 10; }
        .string::before { content:''; position: absolute; left:0; right:0; height:2px; background: rgba(255,255,255,0.5); }
        .string.vibrating::before { background: #d400ff; height: 3px; box-shadow: 0 0 10px #d400ff; }
        .finger-dot { position: absolute; width: 14px; height: 14px; background: #d400ff; border-radius: 50%; display: none; transform: translate(-50%, -50%); top: 50%; box-shadow: 0 0 5px #fff; z-index: 20; }

        /* GA-TAROT */
        .tarot-section { width: 95%; margin: 0 auto 100px auto; text-align: center; background: linear-gradient(135deg, #1a0b2e 0%, #000 100%); padding: 40px 20px; border-radius: 20px; border: 1px solid #4a3068; box-shadow: 0 0 40px rgba(74, 48, 104, 0.4); }
        .tarot-container { perspective: 1000px; width: 220px; height: 340px; margin: 20px auto; cursor: pointer; }
        .tarot-card { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.8s; border-radius: 15px; }
        .tarot-card.flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 15px; display: flex; justify-content: center; align-items: center; flex-direction: column; overflow: hidden; }
        .card-back { background: linear-gradient(45deg, #111, #222); border: 2px solid #d400ff; }
        .card-back::after { content: 'üêæ'; font-size: 4rem; color: #d400ff; animation: pulse 2s infinite; }
        .card-front { background: #0f0f0f; border: 2px solid #d400ff; transform: rotateY(180deg); padding: 10px; }
        .tarot-image-container { width: 160px; height: 160px; margin-bottom: 10px; border-radius: 10px; overflow: hidden; border: 2px solid #d400ff; }
        .tarot-image-actual { width: 100%; height: 100%; object-fit: cover; }
        .tarot-name { font-size: 1.2rem; color: #d400ff; font-weight: bold; margin-bottom: 5px; }
        .tarot-meaning { font-size: 0.85rem; color: #ccc; line-height: 1.3; }

        /* --- ZONA ARCADE --- */
        .arcade-section { width: 95%; max-width: 600px; margin: 0 auto 150px auto; background: #111; border: 4px solid #d400ff; border-radius: 10px; position: relative; overflow: hidden; height: 350px; box-shadow: 0 0 20px rgba(212, 0, 255, 0.3); touch-action: none; background-size: cover; background-position: center; }
        #gameCanvas { width: 100%; height: 100%; display: block; background: transparent; }
        .game-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; pointer-events: none; }
        .game-overlay.hidden { display: none; pointer-events: none; }
        .game-title { font-size: 2rem; color: #ffd700; text-shadow: 2px 2px #d400ff; margin-bottom: 10px; font-weight: bold; }
        .game-msg { font-size: 1rem; color: white; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } } @keyframes pulse { 0% { opacity: 0.5; transform: scale(1); } 50% { opacity: 1; transform: scale(1.1); } 100% { opacity: 0.5; transform: scale(1); } }

        /* MODAL Y PLAYER */
        #noteModal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; justify-content:center; align-items:center; }
        .modal-content { background:#151515; padding:30px; border-radius:10px; width:300px; border:1px solid #d400ff; text-align:center; }
        textarea { width:100%; height:100px; background:#222; color:white; border:1px solid #444; margin:15px 0; padding:10px; }
        
        #music-player { position: fixed; bottom: 20px; left: 5%; width: 90%; background: rgba(15, 15, 15, 0.95); border: 1px solid #d400ff; padding: 10px 20px; border-radius: 50px; z-index: 1000; display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .controls button { background: none; border: none; color: white; cursor: pointer; font-size: 1.5rem; padding: 0 10px;}
        .song-info { font-size: 0.9rem; max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #d400ff; }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1 style="color:white; margin-bottom: 30px;">El Universo de Sofi ‚ú®</h1>
        <button id="start-btn" onclick="startExperience()">Entrar</button>
    </div>

    <div id="scene-container"></div>
    <p class="instruction">‚ú® Gira y busca tu nombre escondido (¬°Puedes hacer Zoom!) ‚ú®</p>

    <div class="bottom-section">
        <div class="card">
            <h2>Bienvenida</h2>
            <p>Arriba: Universo realista 3D. Abajo: M√∫sica, Ukelele, Tarot y... ¬°baja hasta el final para jugar!</p>
        </div>
        <div class="card">
            <h2>Calendario</h2>
            <p>Haz clic en un d√≠a para dejar una nota.</p>
        </div>
    </div>

    <div class="calendar-section">
        <div class="calendar-header">
            <button class="btn-nav" onclick="changeMonth(-1)">‚ùÆ</button>
            <h3 id="monthYear"></h3>
            <button class="btn-nav" onclick="changeMonth(1)">‚ùØ</button>
        </div>
        <div class="days-grid" id="calendarGrid"></div>
    </div>

    <div class="uke-section">
        <h2 style="color:#e0c0a0; margin-bottom:15px; font-family: 'Georgia', serif;">Ukelele Pro üé∏</h2>
        <div class="chord-selectors">
            <button class="chord-btn active" onclick="setChord('C')">C</button> <button class="chord-btn" onclick="setChord('G')">G</button> <button class="chord-btn" onclick="setChord('F')">F</button> <button class="chord-btn" onclick="setChord('Am')">Am</button>
            <button class="chord-btn" onclick="setChord('Dm')">Dm</button> <button class="chord-btn" onclick="setChord('Em')">Em</button> <button class="chord-btn" onclick="setChord('A')">A</button> <button class="chord-btn" onclick="setChord('D')">D</button>
            <button class="chord-btn" onclick="setChord('E7')">E7</button> <button class="chord-btn" onclick="setChord('G7')">G7</button> <button class="chord-btn" onclick="setChord('C7')">C7</button> <button class="chord-btn" onclick="setChord('Bb')">Bb</button>
        </div>
        <div class="fretboard" id="fretboard">
            <div class="fret-line" style="left: 25%"></div> <div class="fret-line" style="left: 50%"></div> <div class="fret-line" style="left: 75%"></div>
            <div class="string" data-s="3" data-f="0"> <div class="finger-dot" style="left:12.5%" data-show="1"></div> <div class="finger-dot" style="left:37.5%" data-show="2"></div> <div class="finger-dot" style="left:62.5%" data-show="3"></div> <div class="finger-dot" style="left:87.5%" data-show="4"></div> </div>
            <div class="string" data-s="2" data-f="0"> <div class="finger-dot" style="left:12.5%" data-show="1"></div> <div class="finger-dot" style="left:37.5%" data-show="2"></div> <div class="finger-dot" style="left:62.5%" data-show="3"></div> <div class="finger-dot" style="left:87.5%" data-show="4"></div> </div>
            <div class="string" data-s="1" data-f="0"> <div class="finger-dot" style="left:12.5%" data-show="1"></div> <div class="finger-dot" style="left:37.5%" data-show="2"></div> <div class="finger-dot" style="left:62.5%" data-show="3"></div> <div class="finger-dot" style="left:87.5%" data-show="4"></div> </div>
            <div class="string" data-s="0" data-f="0"> <div class="finger-dot" style="left:12.5%" data-show="1"></div> <div class="finger-dot" style="left:37.5%" data-show="2"></div> <div class="finger-dot" style="left:62.5%" data-show="3"></div> <div class="finger-dot" style="left:87.5%" data-show="4"></div> </div>
        </div>
    </div>

    <div class="tarot-section">
        <h2>üîÆ Ga-Tarot del D√≠a</h2>
        <div class="tarot-container" onclick="flipCard()">
            <div class="tarot-card" id="dailyCard">
                <div class="card-face card-back"></div>
                <div class="card-face card-front">
                    <div class="tarot-image-container"><img id="tarotImageSrc" class="tarot-image-actual" src=""></div>
                    <div class="tarot-name" id="tarotName"></div>
                    <div class="tarot-meaning" id="tarotMeaning"></div>
                </div>
            </div>
        </div>
        <p id="tarot-date" style="margin-top:20px; font-size: 0.8rem; color:#666;"></p>
    </div>

    <div class="arcade-section" id="arcadeArea">
        <canvas id="gameCanvas"></canvas>
        <div id="gameOverlay" class="game-overlay">
            <div class="game-title" id="gameTitle">¬°Consola Musical!</div>
            <div class="game-msg">Dale play y toca aqu√≠ para jugar</div>
        </div>
    </div>

    <div id="noteModal">
        <div class="modal-content">
            <h3 id="modalDateTitle">Fecha</h3>
            <textarea id="noteText" placeholder="Escribe aqu√≠..."></textarea>
            <div><button class="btn-nav" onclick="closeModal()">Cerrar</button><button class="btn-nav" style="background:#d400ff; color:white;" onclick="saveNote()">Guardar ‚òÅÔ∏è</button></div>
        </div>
    </div>

    <div id="music-player">
        <span class="song-info" id="songTitle">M√∫sica</span>
        <div class="controls">
            <button onclick="prevSong()">‚èÆ</button>
            <button onclick="togglePlay()" id="playBtn">‚ñ∂</button>
            <button onclick="nextSong()">‚è≠</button>
        </div>
        <audio id="audioPlayer"></audio>
    </div>

    <script>
        // --- 1. FIREBASE SETUP (PON TUS DATOS AQU√ç) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCvzZNhb97ABzhKalhPppHwcfUMG5lGVyg",
            authDomain: "regalo-sofi-31bd7.firebaseapp.com",
            databaseURL: "https://regalo-sofi-31bd7-default-rtdb.firebaseio.com",
            projectId: "regalo-sofi-31bd7",
            storageBucket: "regalo-sofi-31bd7.firebasestorage.app",
            messagingSenderId: "896831826087",
            appId: "1:896831826087:web:d9a067f38828a5c1eb1382"
        };
        try { firebase.initializeApp(firebaseConfig); var database = firebase.database(); } catch(e){}

        // --- 2. START & AUDIO ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        // --- CARGAR ASSETS ---
        const gameAssets = {
            fondoTaxi: new Image(), fondoJardin: new Image(), fondoCorrer: new Image(), fondoSnake: new Image(),
            taxi: new Image(), carEnemy: new Image(),
            basket: new Image(), stone: new Image(),
            nave: new Image(), propul: new Image(), estrella: new Image(), asteroide: new Image(),
            snakeHead: new Image(), snakeBody: new Image(),
            obsCielo: new Image(), obsTierra: new Image(),
            bubbleGood: new Image(), bubbleBad: new Image(), expGood: new Image(), expBad: new Image(),
            chicoFrames: [], runnerFrames: [], flowerTypes: [], foods: []
        };

        // Fuentes
        gameAssets.fondoTaxi.src = 'fondotaxihecho.png';
        gameAssets.fondoJardin.src = 'verde.png';
        gameAssets.fondoCorrer.src = 'fondocorrer.png';
        gameAssets.fondoSnake.src = 'fondoserpiente.png';
        
        gameAssets.taxi.src = 'taxi.png';
        gameAssets.carEnemy.src = 'cocheobstaculo.png';
        gameAssets.basket.src = 'cesta.png';
        gameAssets.stone.src = 'piedra.png';
        
        gameAssets.nave.src = 'nave.png';
        gameAssets.propul.src = 'propulsion.png';
        gameAssets.estrella.src = 'estrella.png';
        gameAssets.asteroide.src = 'asteroide.png';
        
        gameAssets.snakeHead.src = 'cabezaserpiente.png';
        gameAssets.snakeBody.src = 'cuerposerpiente.png';
        
        gameAssets.obsCielo.src = 'obstaculocielo.png';
        gameAssets.obsTierra.src = 'obstaculotierra.png';

        gameAssets.bubbleGood.src = 'burbujacorazon.png';
        gameAssets.bubbleBad.src = 'burbujacorazonroto.png';
        gameAssets.expGood.src = 'explosioncorazon.png';
        gameAssets.expBad.src = 'explosioncorazonroto.png';

        ['2frame.png', '3frame.png', '4frame.png', '5frame.png', '6frames.png'].forEach(f => { let img=new Image(); img.src=f; gameAssets.chicoFrames.push(img); });
        ['1correr.png', '2correr.png', '3correr.png', '4correr.png'].forEach(f => { let img=new Image(); img.src=f; gameAssets.runnerFrames.push(img); });
        ['ortalisa.png', 'hortensia.png', 'orquidea.png', 'girasol.png', 'rosa.png', 'tulipan.png'].forEach(f => { let img=new Image(); img.src=f; gameAssets.flowerTypes.push(img); });
        ['gloss.png', 'anillo.png', 'pesa.png', 'pollo.png', 'sushi.png'].forEach(f => { let img=new Image(); img.src=f; gameAssets.foods.push(img); });

        function startExperience() {
            if(audioCtx.state==='suspended') audioCtx.resume();
            document.getElementById('start-screen').style.opacity='0';
            setTimeout(()=>{document.getElementById('start-screen').style.display='none';},1000);
            init3D();
        }

        // --- 3. ARCADE GAME ENGINE ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const overlay = document.getElementById('gameOverlay');
        const gameTitle = document.getElementById('gameTitle');
        const arcadeDiv = document.getElementById('arcadeArea'); // Para cambiar fondo
        let gameId, score=0, gameActive=false, currentGameType="";
        let frameCount = 0;
        let bgY_taxi = 0, bgY_flores = 0, bgX_runner = 0; const SCROLL_SPEED = 5;

        function resizeGame() { canvas.width = canvas.parentElement.clientWidth; canvas.height = canvas.parentElement.clientHeight; }
        window.addEventListener('resize', resizeGame); resizeGame();

        let inputX = 0;
        let mouseX = 0, mouseY = 0;

        canvas.addEventListener('mousemove', (e) => { mouseX = e.offsetX; mouseY = e.offsetY; });
        canvas.addEventListener('mousedown', (e) => {
            if(!gameActive) { startGame(); return; }
            inputX = (e.offsetX < canvas.width/2) ? -1 : 1;
            if(currentGameType === 'neo') checkNeoClick(e.offsetX, e.offsetY);
            if(currentGameType === 'snake') handleSnakeInput(e.offsetX, e.offsetY);
        });
        canvas.addEventListener('mouseup', () => inputX = 0);
        
        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            mouseX = e.touches[0].clientX - rect.left;
            mouseY = e.touches[0].clientY - rect.top;
        }, {passive:false});
        canvas.addEventListener('touchstart', (e) => {
            if(!gameActive) { startGame(); return; }
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            mouseX = e.touches[0].clientX - rect.left;
            mouseY = e.touches[0].clientY - rect.top;
            inputX = (mouseX < canvas.width/2) ? -1 : 1;
            if(currentGameType === 'neo') checkNeoClick(mouseX, mouseY);
            if(currentGameType === 'snake') handleSnakeInput(mouseX, mouseY);
        }, {passive:false});
        canvas.addEventListener('touchend', () => inputX = 0);

        function loadGameForSong(songName) {
            gameActive = false; cancelAnimationFrame(gameId); overlay.classList.remove('hidden');
            // Reset background
            arcadeDiv.style.backgroundImage = "none";
            
            if(songName.includes("Taxi")) { currentGameType = "taxi"; gameTitle.innerText = "üöï Crazy Taxi"; }
            else if(songName.includes("Flores")) { currentGameType = "flores"; gameTitle.innerText = "üå∏ Jard√≠n de Sofi"; }
            else if(songName.includes("NeoRoneo")) { currentGameType = "neo"; gameTitle.innerText = "üé∏ NeoRoneo Love"; }
            else if(songName.includes("Enamorado")) { currentGameType = "runner"; gameTitle.innerText = "üèÉ Enamorado Runner"; }
            else if(songName.includes("Hecho para ti")) { currentGameType = "snake"; gameTitle.innerText = "üêç Snake de Favoritos"; }
            else if(songName.includes("No digas nada")) { 
                currentGameType = "space"; 
                gameTitle.innerText = "üöÄ Viaje Gal√°ctico";
                // ACTIVA EL GIF AQU√ç
                arcadeDiv.style.backgroundImage = "url('galaxiafondo.gif')";
            }
            else { currentGameType = "visual"; gameTitle.innerText = "‚ù§Ô∏è Ritmo Relax"; }
        }

        function startGame() {
            gameActive = true; overlay.classList.add('hidden'); score = 0; frameCount = 0;
            if(currentGameType === "taxi") initTaxi();
            else if(currentGameType === "flores") initFlores();
            else if(currentGameType === "neo") initNeo();
            else if(currentGameType === "runner") initRunner();
            else if(currentGameType === "snake") initSnake();
            else if(currentGameType === "space") initSpace();
            else initVisual();
        }

        // TAXI
        let carX, obstacles;
        function initTaxi() { carX = canvas.width/2; obstacles = []; bgY_taxi = 0; loopTaxi(); }
        function loopTaxi() {
            if(!gameActive) return;
            bgY_taxi = (bgY_taxi + SCROLL_SPEED) % canvas.height;
            if(gameAssets.fondoTaxi.complete) {
                ctx.drawImage(gameAssets.fondoTaxi, 0, bgY_taxi - canvas.height, canvas.width, canvas.height);
                ctx.drawImage(gameAssets.fondoTaxi, 0, bgY_taxi, canvas.width, canvas.height);
            } else { ctx.fillStyle="#333"; ctx.fillRect(0,0,canvas.width,canvas.height); }

            if(inputX < 0 && carX > 40) carX -= 6; if(inputX > 0 && carX < canvas.width - 40) carX += 6;
            if(gameAssets.taxi.complete) ctx.drawImage(gameAssets.taxi, carX-25, canvas.height-80, 50, 80);
            
            if(Math.random() < 0.02) obstacles.push({x: Math.random()*(canvas.width-60)+30, y: -60});
            for(let i=0; i<obstacles.length; i++) {
                let o = obstacles[i]; o.y += 7;
                if(gameAssets.carEnemy.complete) ctx.drawImage(gameAssets.carEnemy, o.x-25, o.y, 50, 80);
                if(Math.abs(o.x - carX) < 40 && Math.abs(o.y - (canvas.height-80)) < 70) { gameOver(); return; }
            }
            score++; drawScore(); gameId = requestAnimationFrame(loopTaxi);
        }

        // FLORES
        let basketX, fallingObjects;
        function initFlores() { basketX = canvas.width/2; fallingObjects = []; bgY_flores = 0; loopFlores(); }
        function loopFlores() {
            if(!gameActive) return;
            bgY_flores = (bgY_flores + SCROLL_SPEED) % canvas.height;
            if(gameAssets.fondoJardin.complete) {
                ctx.drawImage(gameAssets.fondoJardin, 0, bgY_flores - canvas.height, canvas.width, canvas.height);
                ctx.drawImage(gameAssets.fondoJardin, 0, bgY_flores, canvas.width, canvas.height);
            } else { ctx.fillStyle="#2a5"; ctx.fillRect(0,0,canvas.width,canvas.height); }

            if(inputX < 0 && basketX > 30) basketX -= 6; if(inputX > 0 && basketX < canvas.width - 30) basketX += 6;
            if(gameAssets.basket.complete) ctx.drawImage(gameAssets.basket, basketX-30, canvas.height-50, 60, 40);

            if(Math.random() < 0.03) {
                let isStone = Math.random() > 0.8; 
                let fIndex = Math.floor(Math.random() * gameAssets.flowerTypes.length);
                fallingObjects.push({x: Math.random()*canvas.width, y: -30, type: isStone ? 'stone' : 'flower', id: fIndex});
            }
            for(let i=0; i<fallingObjects.length; i++) {
                let o = fallingObjects[i]; o.y += 3;
                if(o.type === 'flower') {
                    let img = gameAssets.flowerTypes[o.id];
                    if(img && img.complete) ctx.drawImage(img, o.x-15, o.y-15, 30, 30);
                } else {
                    if(gameAssets.stone.complete) ctx.drawImage(gameAssets.stone, o.x-15, o.y-15, 30, 30);
                }
                if(Math.abs(o.x - basketX) < 40 && Math.abs(o.y - (canvas.height-40)) < 30) {
                    if(o.type === 'stone') { gameOver(); return; }
                    score += 10; fallingObjects.splice(i, 1); i--;
                }
            }
            drawScore(); gameId = requestAnimationFrame(loopFlores);
        }

        // NEORONEO
        let neoBubbles;
        function initNeo() { neoBubbles = []; loopNeo(); }
        function loopNeo() {
            if(!gameActive) return;
            ctx.fillStyle = "#102"; ctx.fillRect(0,0,canvas.width,canvas.height);
            frameCount++;
            if(gameAssets.chicoFrames.length > 0) {
                let frameIndex = Math.floor(frameCount / 10) % gameAssets.chicoFrames.length;
                let currentImg = gameAssets.chicoFrames[frameIndex];
                if(currentImg && currentImg.complete) ctx.drawImage(currentImg, canvas.width/2 - 60, canvas.height - 130, 120, 120);
            }
            if(Math.random() < 0.04) {
                let t = Math.random() > 0.3 ? 'good' : 'bad';
                neoBubbles.push({x: Math.random()*(canvas.width-40)+20, y: -50, type: t, isExploding: false, expStart: 0});
            }
            for(let i=0; i<neoBubbles.length; i++) {
                let b = neoBubbles[i];
                if(b.isExploding) {
                    let elapsed = Date.now() - b.expStart;
                    if(elapsed < 300) { 
                        let expImg = (b.type === 'good') ? gameAssets.expGood : gameAssets.expBad;
                        if(expImg.complete) ctx.drawImage(expImg, b.x-30, b.y-30, 60, 60);
                    } else {
                        if(b.type === 'good') score += 10; else { gameOver(); return; }
                        neoBubbles.splice(i, 1); i--;
                    }
                } else {
                    b.y += 2.5;
                    let img = (b.type === 'good') ? gameAssets.bubbleGood : gameAssets.bubbleBad;
                    if(img.complete) ctx.drawImage(img, b.x-25, b.y-25, 50, 50);
                    if(b.y > canvas.height + 50) { neoBubbles.splice(i,1); i--; }
                }
            }
            drawScore(); gameId = requestAnimationFrame(loopNeo);
        }
        function checkNeoClick(x, y) {
            for(let i=0; i<neoBubbles.length; i++) {
                let b = neoBubbles[i];
                if(!b.isExploding && Math.sqrt((x-b.x)**2 + (y-b.y)**2) < 40) {
                    b.isExploding = true; b.expStart = Date.now(); break; 
                }
            }
        }

        // RUNNER
        let runnerY, runObstacles;
        function initRunner() { runnerY = canvas.height/2; runObstacles = []; bgX_runner = 0; loopRunner(); }
        function loopRunner() {
            if(!gameActive) return;
            frameCount++;
            bgX_runner = (bgX_runner - 3) % canvas.width;
            if(gameAssets.fondoCorrer.complete) {
                ctx.drawImage(gameAssets.fondoCorrer, bgX_runner, 0, canvas.width, canvas.height);
                ctx.drawImage(gameAssets.fondoCorrer, bgX_runner + canvas.width, 0, canvas.width, canvas.height);
            } else { ctx.fillStyle = "skyblue"; ctx.fillRect(0,0,canvas.width,canvas.height); }

            if(mouseY > 0) runnerY += (mouseY - runnerY) * 0.1;
            
            if(gameAssets.runnerFrames.length > 0) {
                let frameIndex = Math.floor(frameCount / 8) % gameAssets.runnerFrames.length;
                let img = gameAssets.runnerFrames[frameIndex];
                if(img.complete) ctx.drawImage(img, 50, runnerY-30, 60, 60);
            }

            if(Math.random() < 0.02) {
                let isSky = Math.random() > 0.5;
                runObstacles.push({x: canvas.width, y: isSky ? Math.random()*100 : canvas.height-Math.random()*100-50, type: isSky ? 'sky' : 'ground'});
            }
            for(let i=0; i<runObstacles.length; i++) {
                let o = runObstacles[i]; o.x -= 5;
                let img = (o.type === 'sky') ? gameAssets.obsCielo : gameAssets.obsTierra;
                if(img.complete) ctx.drawImage(img, o.x, o.y, 60, 60); 
                
                if(o.x < 90 && o.x > 30 && Math.abs((runnerY) - (o.y+30)) < 40) { gameOver(); return; }
                if(o.x < -60) { runObstacles.splice(i,1); i--; score += 5; }
            }
            drawScore(); gameId = requestAnimationFrame(loopRunner);
        }

        // SNAKE
        let snake, dir, food; const gridSize = 20;
        function initSnake() { 
            snake = [{x:10, y:10}, {x:9, y:10}]; dir = {x:1, y:0}; 
            spawnFood(); setTimeout(loopSnake, 200); // M√ÅS LENTO
        }
        function spawnFood() {
            food = {
                x: Math.floor(Math.random() * (canvas.width/gridSize)),
                y: Math.floor(Math.random() * (canvas.height/gridSize)),
                type: Math.floor(Math.random() * gameAssets.foods.length)
            };
        }
        function handleSnakeInput(x, y) {
            let head = snake[0];
            let screenX = head.x * gridSize; let screenY = head.y * gridSize;
            if(Math.abs(x - screenX) > Math.abs(y - screenY)) {
                if(x > screenX && dir.x === 0) dir = {x:1, y:0};
                else if(x < screenX && dir.x === 0) dir = {x:-1, y:0};
            } else {
                if(y > screenY && dir.y === 0) dir = {x:0, y:1};
                else if(y < screenY && dir.y === 0) dir = {x:0, y:-1};
            }
        }
        function loopSnake() {
            if(!gameActive) return;
            
            // Fondo est√°tico
            if(gameAssets.fondoSnake.complete) ctx.drawImage(gameAssets.fondoSnake, 0, 0, canvas.width, canvas.height);
            else { ctx.fillStyle = "#222"; ctx.fillRect(0,0,canvas.width,canvas.height); }
            
            let head = {x: snake[0].x + dir.x, y: snake[0].y + dir.y};
            if(head.x < 0 || head.x >= canvas.width/gridSize || head.y < 0 || head.y >= canvas.height/gridSize) { gameOver(); return; }
            for(let p of snake) if(head.x === p.x && head.y === p.y) { gameOver(); return; }

            snake.unshift(head);
            if(head.x === food.x && head.y === food.y) { score += 10; spawnFood(); } else { snake.pop(); }

            let fImg = gameAssets.foods[food.type];
            if(fImg && fImg.complete) ctx.drawImage(fImg, food.x*gridSize, food.y*gridSize, gridSize, gridSize);

            for(let i=0; i<snake.length; i++) {
                let p = snake[i];
                if(i===0 && gameAssets.snakeHead.complete) {
                    ctx.save();
                    ctx.translate(p.x*gridSize + gridSize/2, p.y*gridSize + gridSize/2);
                    let angle = 0;
                    if(dir.x === 1) angle = 0;
                    if(dir.x === -1) angle = Math.PI;
                    if(dir.y === 1) angle = Math.PI/2;
                    if(dir.y === -1) angle = -Math.PI/2;
                    ctx.rotate(angle);
                    ctx.drawImage(gameAssets.snakeHead, -gridSize/2, -gridSize/2, gridSize, gridSize);
                    ctx.restore();
                }
                else if(gameAssets.snakeBody.complete) ctx.drawImage(gameAssets.snakeBody, p.x*gridSize, p.y*gridSize, gridSize, gridSize);
                else { ctx.fillStyle="lime"; ctx.fillRect(p.x*gridSize, p.y*gridSize, gridSize, gridSize); }
            }
            drawScore(); setTimeout(() => requestAnimationFrame(loopSnake), 200); // VELOCIDAD CONTROLADA
        }

        // SPACE (NO DIGAS NADA)
        let naveX, naveY, spaceObjects;
        function initSpace() { naveX = canvas.width/2; naveY = canvas.height/2; spaceObjects = []; loopSpace(); }
        function loopSpace() {
            if(!gameActive) return;
            // El fondo se maneja por CSS (GIF) as√≠ que limpiamos
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if(mouseX > 0) {
                naveX += (mouseX - naveX) * 0.05;
                naveY += (mouseY - naveY) * 0.05;
            }
            
            ctx.save();
            ctx.translate(naveX, naveY);
            let dx = mouseX - naveX; let dy = mouseY - naveY;
            let angle = Math.atan2(dy, dx); 
            ctx.rotate(angle + Math.PI); 

            if(gameAssets.nave.complete) {
                // Nave m√°s chica (35x35)
                ctx.drawImage(gameAssets.nave, -17, -17, 35, 35);
                // Propulsi√≥n vibrante
                if(gameAssets.propul.complete) {
                    let bob = Math.sin(Date.now() / 100) * 2;
                    ctx.drawImage(gameAssets.propul, 18 + bob, -8, 20, 16); 
                }
            }
            ctx.restore();

            if(Math.random() < 0.03) {
                let isAst = Math.random() > 0.6; 
                spaceObjects.push({x: Math.random()*canvas.width, y: -30, type: isAst?'ast':'star'});
            }

            for(let i=0; i<spaceObjects.length; i++) {
                let o = spaceObjects[i]; o.y += 4;
                let img = (o.type === 'ast') ? gameAssets.asteroide : gameAssets.estrella;
                if(img.complete) ctx.drawImage(img, o.x-15, o.y-15, 30, 30);
                
                if(Math.abs(o.x - naveX) < 30 && Math.abs(o.y - naveY) < 30) {
                    if(o.type === 'ast') { gameOver(); return; }
                    else { score += 20; spaceObjects.splice(i,1); i--; }
                }
            }
            drawScore(); gameId = requestAnimationFrame(loopSpace);
        }

        function initVisual() { loopVisual(); }
        function loopVisual() {
            if(!gameActive) return;
            ctx.fillStyle = "rgba(0,0,0,0.1)"; ctx.fillRect(0,0,canvas.width,canvas.height);
            let s = 1 + Math.sin(Date.now()/300)*0.2;
            ctx.font = (50*s)+"px Arial"; ctx.textAlign="center"; ctx.fillText("‚ù§Ô∏è", canvas.width/2, canvas.height/2);
            gameId = requestAnimationFrame(loopVisual);
        }

        function drawScore() { ctx.fillStyle="white"; ctx.font="20px Arial"; ctx.fillText("Score: "+score, 60, 30); }
        function gameOver() { gameActive = false; gameTitle.innerText = "Game Over!"; overlay.classList.remove('hidden'); }

        // --- 4. UKELELE L√ìGICA ---
        const openFreqs = [440.00, 329.63, 261.63, 392.00]; 
        const chords = { 'C':[3,0,0,0], 'G':[2,3,2,0], 'F':[0,1,0,2], 'Am':[0,0,0,2], 'Dm':[0,1,2,2], 'Em':[2,3,4,0], 'A':[0,0,1,2], 'D':[0,2,2,2], 'E7':[2,0,2,1], 'G7':[2,1,2,0], 'C7':[1,0,0,0], 'Bb':[1,1,2,3] };
        let currentShape = chords['C'];
        function setChord(name) {
            currentShape = chords[name];
            document.querySelectorAll('.chord-btn').forEach(b => b.classList.remove('active')); event.target.classList.add('active');
            document.querySelectorAll('.string').forEach((str, i) => {
                const logicIdx = 3 - i; const fret = currentShape[logicIdx];
                str.querySelectorAll('.finger-dot').forEach(d => d.style.display = 'none'); str.setAttribute('data-f', fret);
                if(fret > 0) str.querySelector(`.finger-dot[data-show="${fret}"]`).style.display = 'block';
            });
        }
        setTimeout(() => setChord('C'), 500);
        function playString(idx) {
            const fret = currentShape[idx]; const freq = openFreqs[idx] * Math.pow(2, fret/12);
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.type = 'triangle'; osc.frequency.value = freq; osc.connect(gain); gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime; gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(0.4, now+0.02); gain.gain.exponentialRampToValueAtTime(0.001, now+1.5);
            osc.start(now); osc.stop(now+1.5);
            const strEl = document.querySelectorAll('.string')[3-idx]; if(strEl) { strEl.classList.add('vibrating'); setTimeout(()=>strEl.classList.remove('vibrating'),200); }
        }
        const fretboard = document.getElementById('fretboard');
        fretboard.addEventListener('mousemove', (e) => { if(e.buttons===1) checkStrum(e); });
        fretboard.addEventListener('touchmove', (e) => { e.preventDefault(); checkStrum(e.touches[0]); }, {passive:false});
        function checkStrum(p) { const el = document.elementFromPoint(p.clientX, p.clientY); if(el && el.classList.contains('string') && !el.classList.contains('vibrating')) playString(parseInt(el.getAttribute('data-s'))); }
        document.querySelectorAll('.string').forEach(s => s.addEventListener('mousedown', ()=>playString(parseInt(s.getAttribute('data-s')))));

        // --- 5. CALENDARIO ---
        let currentDate = new Date();
        const monthYearEl = document.getElementById('monthYear'); const calendarGrid = document.getElementById('calendarGrid');
        const modal = document.getElementById('noteModal'); const noteText = document.getElementById('noteText');
        let selectedDateKey = null; let allNotes = {};
        if(database) database.ref('calendario_notas').on('value', (s) => { allNotes = s.val() || {}; renderCalendar(); });
        function renderCalendar() {
            const year = currentDate.getFullYear(); const month = currentDate.getMonth();
            monthYearEl.innerText = new Date(year, month).toLocaleString('es-ES', { month: 'long', year: 'numeric' });
            calendarGrid.innerHTML = '';
            ['D','L','M','X','J','V','S'].forEach(d => { const el = document.createElement('div'); el.innerText=d; el.style.color='#777'; calendarGrid.appendChild(el); });
            for(let i=0; i<new Date(year, month, 1).getDay(); i++) calendarGrid.appendChild(document.createElement('div'));
            for(let i=1; i<=new Date(year, month+1, 0).getDate(); i++) {
                const cell = document.createElement('div'); cell.className = 'day-cell'; cell.innerText = i;
                const key = `${i}-${month}-${year}`;
                if(i===new Date().getDate() && month===new Date().getMonth()) cell.classList.add('today');
                if(allNotes[key]) cell.classList.add('has-note');
                cell.onclick = () => { selectedDateKey = key; document.getElementById('modalDateTitle').innerText = key.replace(/-/g, '/'); noteText.value = allNotes[key] || ''; modal.style.display = 'flex'; };
                calendarGrid.appendChild(cell);
            }
        }
        function changeMonth(d) { currentDate.setMonth(currentDate.getMonth()+d); renderCalendar(); }
        function closeModal() { modal.style.display = 'none'; }
        function saveNote() { const val = noteText.value.trim(); if(val) database.ref('calendario_notas/'+selectedDateKey).set(val); else database.ref('calendario_notas/'+selectedDateKey).remove(); closeModal(); }
        renderCalendar();

        // --- 6. GA-TAROT ---
        const deck = [
            { image: "Michichay.jpeg", name: "El Protagonista", meaning: "Como Michichay, hoy eres el centro de la historia. ¬°Brilla con tu luz propia!" },
            { image: "Fotooo.jpeg", name: "La Musa (T√∫)", meaning: "La carta m√°s bella. Hoy irradias arte e inspiraci√≥n. El universo te sonr√≠e.üíï" },
            { image: "Gato Drogo.jpeg", name: "El Gato Drogo", meaning: "Est√°s en las nubes, so√±ando despierta. D√©jate llevar por la imaginaci√≥n." },
            { image: "Gato Cachondo.jpeg", name: "Pura Pasi√≥n", meaning: "Fuego en el aire. Te sientes magn√©tica. Cuidado con lo que deseas." },
            { image: "Trio bandido.jpeg", name: "Los C√≥mplices", meaning: "Amistad y travesuras. R√≠ete de todo con los tuyos." },
            { image: "Gato pingui√±o.jpeg", name: "El Elegante", meaning: "Tienes un estilo √∫nico. Acepta tu rareza, es tu superpoder." },
            { image: "Gato berrako.jpeg", name: "La Jefa", meaning: "Hoy mandas t√∫. Tienes la fuerza para lograr lo que quieras." }
        ];
        function flipCard() {
            const cardEl = document.getElementById('dailyCard'); if(cardEl.classList.contains('flipped')) return;
            const idx = Math.abs(new Date().toDateString().split('').reduce((a,b)=>a+b.charCodeAt(0),0)) % deck.length;
            const data = deck[idx];
            document.getElementById('tarotImageSrc').src = data.image; 
            document.getElementById('tarotName').innerText = data.name;
            document.getElementById('tarotMeaning').innerText = data.meaning;
            cardEl.classList.add('flipped');
            document.getElementById('tarot-date').innerText = "Predicci√≥n gatuna para el " + new Date().toLocaleDateString('es-ES', {weekday:'long', day:'numeric', month:'long'});
        }

        // --- 7. 3D UNIVERSO ---
        let camera, scene, renderer, controls, wordGroup, starField;
        const container = document.getElementById('scene-container');
        function init3D() {
            if(renderer) return; 
            scene = new THREE.Scene(); scene.fog = new THREE.FogExp2(0x000000, 0.0015);
            camera = new THREE.PerspectiveCamera(60, container.clientWidth/container.clientHeight, 0.1, 3000); camera.position.z = 800;
            renderer = new THREE.WebGLRenderer({alpha:true, antialias:true}); renderer.setSize(container.clientWidth, container.clientHeight); container.appendChild(renderer.domElement);
            controls = new THREE.OrbitControls(camera, renderer.domElement); controls.enableDamping=true; controls.enablePan=false; controls.autoRotate=true; controls.autoRotateSpeed=0.3;
            controls.addEventListener('start', () => controls.autoRotate=false);
            
            const geo = new THREE.BufferGeometry(); const pos = []; const sizes = [];
            for(let i=0; i<5000; i++) { pos.push((Math.random()-0.5)*3000, (Math.random()-0.5)*3000, (Math.random()-0.5)*3000); sizes.push(Math.random()*3+0.5); }
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3)); geo.setAttribute('size', new THREE.Float32BufferAttribute(sizes, 1));
            const tex = new THREE.CanvasTexture((function(){ const c=document.createElement('canvas');c.width=64;c.height=64;const x=c.getContext('2d');const g=x.createRadialGradient(32,32,0,32,32,32);g.addColorStop(0,'white');g.addColorStop(1,'transparent');x.fillStyle=g;x.fillRect(0,0,64,64);return c;})());
            const mat = new THREE.PointsMaterial({color:0xffffff, size:4, map:tex, transparent:true, blending:THREE.AdditiveBlending, depthWrite:false, sizeAttenuation:true});
            starField = new THREE.Points(geo, mat); scene.add(starField);
            
            wordGroup = new THREE.Group();
            const lMat = new THREE.LineBasicMaterial({color:0xff00ff, opacity:0.8, transparent:true});
            const pMat = new THREE.PointsMaterial({color:0xffffff, size:5, map:tex, transparent:true, blending:THREE.AdditiveBlending});
            const letters = [
                [[0,30],[-20,30],[-20,0],[0,0],[0,-30],[-20,-30]], // S
                [[-20,30],[0,30],[0,-30],[-20,-30],[-20,30]], // O
                [[-20,-30],[-20,30],[0,30],[-20,30],[-20,0],[0,0]], // F
                [[0,30],[0,-30]] // I
            ];
            let xOff = -60;
            letters.forEach((l, index) => {
                const pts = l.map(p => new THREE.Vector3(p[0]+xOff, p[1], 0));
                const g = new THREE.BufferGeometry().setFromPoints(pts);
                wordGroup.add(new THREE.Line(g, lMat), new THREE.Points(g, pMat));
                xOff += (index === 2) ? 25 : 35; 
            });
            wordGroup.rotation.set(Math.random()*6, Math.random()*6, Math.random()*6);
            wordGroup.position.set((Math.random()-0.5)*1000, (Math.random()-0.5)*1000, (Math.random()-0.5)*1000);
            scene.add(wordGroup);
            animate();
        }
        function animate() { requestAnimationFrame(animate); controls.update(); if(starField) starField.rotation.y+=0.0002; renderer.render(scene, camera); }
        window.addEventListener('resize', () => { if(camera){ camera.aspect = container.clientWidth/container.clientHeight; camera.updateProjectionMatrix(); renderer.setSize(container.clientWidth, container.clientHeight); resizeGame(); }});

        // 8. PLAYER & ARCADE LINK
        const playlist = [ 
            {title:"Taxi", file:"Taxi.mp3"}, 
            {title:"Enamorado", file:"Enamorado.mp3"},
            {title:"Flores", file:"Flores.mp3"},
            {title:"Hecho para ti", file:"Hechoparati.mp3"},
            {title:"No digas nada", file:"Nodigasnada.mp3"},
            {title:"NeoRoneo", file:"NeoRoneo.mp3"}
        ];
        let currSong = 0; const player = document.getElementById('audioPlayer'); let isPlaying = false;
        
        loadGameForSong(playlist[0].title); // Cargar juego inicial

        function togglePlay() {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            if(!playlist.length) return; if(!player.src) player.src = playlist[0].file;
            if(isPlaying) { player.pause(); document.getElementById('playBtn').innerText="‚ñ∂"; }
            else { player.play(); document.getElementById('playBtn').innerText="‚è∏"; }
            isPlaying = !isPlaying;
        }
        function nextSong() { currSong = (currSong+1)%playlist.length; updatePlayer(); }
        function prevSong() { currSong = (currSong-1+playlist.length)%playlist.length; updatePlayer(); }
        function updatePlayer() {
            player.src = playlist[currSong].file;
            const t = playlist[currSong].title;
            document.getElementById('songTitle').innerText = t;
            loadGameForSong(t); // CAMBIAR JUEGO AQU√ç
            if(isPlaying) player.play();
        }
    </script>
</body>
</html>
