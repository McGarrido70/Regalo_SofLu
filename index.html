<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Universo de Sofi</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        /* --- ESTILOS (Iguales a los anteriores, optimizados) --- */
        body { margin: 0; background-color: #050505; color: white; font-family: 'Segoe UI', sans-serif; overflow-x: hidden; }
        
        #scene-container {
            width: 85%; height: 450px; margin: 40px auto; position: relative;
            border: 1px solid #333; border-radius: 15px; overflow: hidden;
            box-shadow: 0 0 40px rgba(212, 0, 255, 0.1); cursor: grab;
        }
        #scene-container:active { cursor: grabbing; }

        .instruction { text-align: center; color: #888; font-size: 0.9rem; margin-top: -30px; margin-bottom: 50px; }

        .bottom-section { display: flex; justify-content: space-between; width: 85%; margin: 0 auto 50px auto; gap: 20px; }
        .card { background: #0f0f0f; border: 1px solid #222; padding: 25px; width: 48%; border-radius: 15px; }
        h2 { color: #d400ff; margin-top: 0; font-size: 1.4rem; }
        p { line-height: 1.6; color: #ccc; font-size: 0.95rem; }

        .calendar-section {
            width: 85%; margin: 0 auto 100px auto; background: #0f0f0f;
            border: 1px solid #222; border-radius: 15px; padding: 20px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-nav { background: #222; color: #d400ff; border: 1px solid #d400ff; padding: 5px 15px; border-radius: 5px; cursor: pointer; }
        .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .day-name { color: #888; font-weight: bold; padding-bottom: 10px; }
        .day-cell { background: #1a1a1a; padding: 15px; border-radius: 8px; cursor: pointer; position: relative; min-height: 40px; }
        .day-cell:hover { background: #2a2a2a; border: 1px solid #555; }
        .day-cell.today { border: 1px solid #d400ff; color: #d400ff; font-weight: bold; }
        
        /* Estrella giratoria si hay nota */
        .has-note::after {
            content: '★'; position: absolute; top: 5px; right: 5px; color: #ffd700; font-size: 0.8rem;
            animation: spin 3s infinite linear;
        }
        @keyframes spin { 0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);} }

        #noteModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: #151515; padding: 30px; border-radius: 10px; width: 300px; border: 1px solid #d400ff; text-align: center; }
        textarea { width: 100%; height: 100px; background: #222; color: white; border: 1px solid #444; margin: 15px 0; border-radius: 5px; padding: 10px; }
        
        #music-player {
            position: fixed; bottom: 20px; left: 20px; background: rgba(15, 15, 15, 0.95);
            border: 1px solid #d400ff; padding: 10px 20px; border-radius: 50px; z-index: 1000;
            display: flex; align-items: center; gap: 15px; box-shadow: 0 0 15px rgba(212, 0, 255, 0.2);
        }
        .controls button { background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; }

        @media (max-width: 768px) {
            .bottom-section { flex-direction: column; }
            .card, .calendar-section { width: 90%; box-sizing: border-box; }
            #music-player { left: 5%; width: 80%; justify-content: space-between; }
        }
    </style>
</head>
<body>

    <div id="scene-container"></div>
    <p class="instruction">✨ Encuentra tu nombre "SOFI" en las estrellas ✨</p>

    <div class="bottom-section">
        <div class="card">
            <h2>Para Sofi</h2>
            <p>Este calendario ahora está conectado a la nube.</p>
            <p>Lo que escribas aquí, yo lo podré leer desde mi casa, y lo que yo escriba te aparecerá a ti. Es nuestro chat secreto.</p>
        </div>
        <div class="card">
            <h2>Música & Recuerdos</h2>
            <p>Dale play y busca tu nota del día.</p>
        </div>
    </div>

    <div class="calendar-section">
        <div class="calendar-header">
            <button class="btn-nav" onclick="changeMonth(-1)">❮</button>
            <h3 id="monthYear"></h3>
            <button class="btn-nav" onclick="changeMonth(1)">❯</button>
        </div>
        <div class="days-grid" id="calendarGrid"></div>
    </div>

    <div id="noteModal">
        <div class="modal-content">
            <h3 id="modalDateTitle">Fecha</h3>
            <textarea id="noteText" placeholder="Escribe un mensaje para nosotros..."></textarea>
            <div>
                <button class="btn-nav" onclick="closeModal()">Cerrar</button>
                <button class="btn-nav" style="background:#d400ff; color:white;" onclick="saveNote()">Guardar en la Nube ☁️</button>
            </div>
        </div>
    </div>

    <div id="music-player">
        <div class="song-info"><span id="songTitle">Elige canción...</span></div>
        <div class="controls">
            <button onclick="prevSong()">⏮</button>
            <button onclick="togglePlay()" id="playBtn">▶</button>
            <button onclick="nextSong()">⏭</button>
        </div>
        <audio id="audioPlayer"></audio>
    </div>

    <script>
        // ---------------------------------------------------------
        // 1. CONFIGURACIÓN DE FIREBASE (¡PEGA TUS DATOS AQUÍ!)
        // ---------------------------------------------------------
        const firebaseConfig = {
  apiKey: "AIzaSyCvzZNhb97ABzhKalhPppHwcfUMG5lGVyg",
  authDomain: "regalo-sofi-31bd7.firebaseapp.com",
  databaseURL: "https://regalo-sofi-31bd7-default-rtdb.firebaseio.com",
  projectId: "regalo-sofi-31bd7",
  storageBucket: "regalo-sofi-31bd7.firebasestorage.app",
  messagingSenderId: "896831826087",
  appId: "1:896831826087:web:d9a067f38828a5c1eb1382"
};
        
        // Inicializar Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();


        // ---------------------------------------------------------
        // 2. LÓGICA DEL CALENDARIO CONECTADO
        // ---------------------------------------------------------
        let currentDate = new Date();
        const monthYearEl = document.getElementById('monthYear');
        const calendarGrid = document.getElementById('calendarGrid');
        const modal = document.getElementById('noteModal');
        const noteText = document.getElementById('noteText');
        let selectedDateKey = null;
        let allNotes = {}; // Aquí guardaremos las notas que vienen de la nube

        // Escuchar cambios en la base de datos en TIEMPO REAL
        const notesRef = database.ref('calendario_notas');
        notesRef.on('value', (snapshot) => {
            const data = snapshot.val();
            allNotes = data || {}; // Si no hay datos, objeto vacío
            renderCalendar(); // Volver a pintar el calendario con las nuevas notas
        });

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            monthYearEl.innerText = new Date(year, month).toLocaleString('es-ES', { month: 'long', year: 'numeric' });
            calendarGrid.innerHTML = '';
            
            const weekDays = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
            weekDays.forEach(day => {
                const div = document.createElement('div');
                div.className = 'day-name'; div.innerText = day; calendarGrid.appendChild(div);
            });

            const firstDayIndex = new Date(year, month, 1).getDay();
            for(let i=0; i<firstDayIndex; i++) calendarGrid.appendChild(document.createElement('div'));

            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();

            for(let i=1; i<=daysInMonth; i++){
                const dayEl = document.createElement('div');
                dayEl.className = 'day-cell';
                dayEl.innerText = i;
                
                // Clave única para guardar (ej: "14-2-2024")
                const dateKey = `${i}-${month}-${year}`;
                
                if(i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) dayEl.classList.add('today');

                // VERIFICAR SI HAY NOTA EN LA NUBE
                if(allNotes[dateKey]) {
                    dayEl.classList.add('has-note');
                    // Opcional: Mostrar preview al pasar mouse
                    dayEl.title = "¡Hay un mensaje!";
                }

                dayEl.onclick = () => openModal(i, month, year);
                calendarGrid.appendChild(dayEl);
            }
        }

        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            renderCalendar();
        }

        function openModal(day, month, year) {
            selectedDateKey = `${day}-${month}-${year}`;
            document.getElementById('modalDateTitle').innerText = `${day} / ${month+1} / ${year}`;
            noteText.value = allNotes[selectedDateKey] || ''; // Cargar texto de la nube
            modal.style.display = 'flex';
        }

        function closeModal() { modal.style.display = 'none'; }

        function saveNote() {
            const texto = noteText.value.trim();
            // Guardar en Firebase
            if(texto === "") {
                database.ref('calendario_notas/' + selectedDateKey).remove();
            } else {
                database.ref('calendario_notas/' + selectedDateKey).set(texto);
            }
            // No hace falta llamar a renderCalendar(), Firebase avisa automáticamente
            closeModal();
            alert("¡Mensaje enviado al universo! ☁️");
        }


        // ---------------------------------------------------------
        // 3. MÚSICA (ACTUALIZA TUS CANCIONES)
        // ---------------------------------------------------------
        const playlist = [
            { title: "Canción 1", file: "cancion1.mp3" },
            { title: "Canción 2", file: "cancion2.mp3" }
        ];
        
        let currentSongIndex = 0;
        const audioPlayer = document.getElementById('audioPlayer');
        const playBtn = document.getElementById('playBtn');
        const titleLabel = document.getElementById('songTitle');
        let isPlaying = false;

        function loadSong(index) {
            if(playlist.length === 0) return;
            audioPlayer.src = playlist[index].file;
            titleLabel.innerText = playlist[index].title;
        }
        function togglePlay() {
            if (playlist.length === 0) return alert("Sube canciones");
            if (!audioPlayer.src) loadSong(0);
            if (isPlaying) { audioPlayer.pause(); playBtn.innerText = "▶"; }
            else { audioPlayer.play(); playBtn.innerText = "⏸"; }
            isPlaying = !isPlaying;
        }
        function nextSong() {
            currentSongIndex = (currentSongIndex + 1) % playlist.length;
            loadSong(currentSongIndex); if(isPlaying) audioPlayer.play();
        }
        function prevSong() {
            currentSongIndex = (currentSongIndex - 1 + playlist.length) % playlist.length;
            loadSong(currentSongIndex); if(isPlaying) audioPlayer.play();
        }

        // ---------------------------------------------------------
        // 4. MUNDO 3D (SOFI ALEATORIO)
        // ---------------------------------------------------------
        let camera, scene, renderer, controls, wordGroup;
        const container = document.getElementById('scene-container');
        init(); animate();

        function init() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.0015);
            camera = new THREE.PerspectiveCamera(60, container.clientWidth / container.clientHeight, 0.1, 2000);
            camera.position.z = 500;
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true; controls.enableZoom = false;

            const starGeo = new THREE.BufferGeometry();
            const starPos = [];
            for(let i=0; i<3000; i++) starPos.push(THREE.MathUtils.randFloatSpread(2000), THREE.MathUtils.randFloatSpread(2000), THREE.MathUtils.randFloatSpread(2000));
            starGeo.setAttribute('position', new THREE.Float32BufferAttribute(starPos, 3));
            scene.add(new THREE.Points(starGeo, new THREE.PointsMaterial({color: 0x888888, size: 1.5})));

            createSofi();
            window.addEventListener('resize', () => {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            });
        }

        function createSofi() {
            wordGroup = new THREE.Group();
            const matLine = new THREE.LineBasicMaterial({color: 0xd400ff, opacity: 0.8, transparent: true});
            const matDot = new THREE.PointsMaterial({color: 0xffffff, size: 4});
            function addLetter(pts, xOff) {
                const geo = new THREE.BufferGeometry().setFromPoints(pts);
                const l = new THREE.Line(geo, matLine); l.position.x = xOff;
                const s = new THREE.Points(geo, matDot); s.position.x = xOff;
                wordGroup.add(l, s);
            }
            const h=40, w=30;
            addLetter([new THREE.Vector3(w,h,0), new THREE.Vector3(0,h,0), new THREE.Vector3(0,0,0), new THREE.Vector3(w,0,0), new THREE.Vector3(w,-h,0), new THREE.Vector3(0,-h,0)], -80);
            addLetter([new THREE.Vector3(0,h,0), new THREE.Vector3(w,h,0), new THREE.Vector3(w,-h,0), new THREE.Vector3(0,-h,0), new THREE.Vector3(0,h,0)], -30);
            addLetter([new THREE.Vector3(w,h,0), new THREE.Vector3(0,h,0), new THREE.Vector3(0,-h,0)], 20);
            addLetter([new THREE.Vector3(0,0,0), new THREE.Vector3(w*0.7,0,0)], 20);
            addLetter([new THREE.Vector3(0,h,0), new THREE.Vector3(0,-h,0)], 70);
            
            wordGroup.rotation.set(Math.random()*6, Math.random()*6, Math.random()*6);
            wordGroup.position.set(Math.random()*400-200, Math.random()*400-200, Math.random()*400-200);
            scene.add(wordGroup);
        }
        function animate() { requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); }
    </script>
</body>
</html>
