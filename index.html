<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Universo de Sofi</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        /* --- ESTILOS GENERALES --- */
        body { margin: 0; background-color: #050505; color: white; font-family: 'Segoe UI', sans-serif; overflow-x: hidden; user-select: none; }
        
        /* Contenedor 3D */
        #scene-container {
            width: 85%; height: 400px; margin: 40px auto; position: relative;
            border: 1px solid #333; border-radius: 15px; overflow: hidden;
            box-shadow: 0 0 30px rgba(212, 0, 255, 0.15); cursor: grab;
        }
        #scene-container:active { cursor: grabbing; }
        .instruction { text-align: center; color: #888; font-size: 0.9rem; margin-top: -30px; margin-bottom: 40px; }

        /* Tarjetas */
        .bottom-section { display: flex; justify-content: space-between; width: 85%; margin: 0 auto 50px auto; gap: 20px; }
        .card { background: #0f0f0f; border: 1px solid #222; padding: 25px; width: 48%; border-radius: 15px; }
        h2 { color: #d400ff; margin-top: 0; font-size: 1.4rem; }
        p { line-height: 1.6; color: #ccc; font-size: 0.95rem; }

        /* Calendario */
        .calendar-section { width: 85%; margin: 0 auto 80px auto; background: #0f0f0f; border: 1px solid #222; border-radius: 15px; padding: 20px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-nav { background: #222; color: #d400ff; border: 1px solid #d400ff; padding: 5px 15px; border-radius: 5px; cursor: pointer; }
        .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .day-name { color: #888; font-weight: bold; padding-bottom: 10px; }
        .day-cell { background: #1a1a1a; padding: 15px; border-radius: 8px; cursor: pointer; position: relative; min-height: 40px; transition: 0.2s; }
        .day-cell:hover { background: #2a2a2a; border: 1px solid #555; }
        .day-cell.today { border: 1px solid #d400ff; color: #d400ff; font-weight: bold; }
        
        /* Estrella giratoria si hay nota */
        .has-note::after { content: '‚òÖ'; position: absolute; top: 5px; right: 5px; color: #ffd700; font-size: 0.8rem; animation: spin 3s infinite linear; }
        @keyframes spin { 0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);} }

        /* --- PIANO ESPACIAL --- */
        .piano-section {
            width: 85%; margin: 0 auto 120px auto;
            text-align: center;
            background: linear-gradient(180deg, #0f0f0f 0%, #1a0b2e 100%);
            padding: 30px; border-radius: 15px; border: 1px solid #333;
        }
        .piano-keys {
            display: flex; justify-content: center; position: relative;
            height: 200px; margin-top: 20px;
        }
        .key {
            width: 60px; height: 100%; background: white; border: 1px solid #ccc;
            border-radius: 0 0 5px 5px; margin: 0 2px; cursor: pointer;
            position: relative; z-index: 1; transition: background 0.1s;
        }
        .key:active, .key.active { background: #d400ff; box-shadow: 0 0 15px #d400ff; border: none; }
        
        .key.black {
            width: 40px; height: 60%; background: #111; z-index: 2;
            position: absolute; margin-left: -20px; 
            border-radius: 0 0 3px 3px;
        }
        .key.black:active, .key.black.active { background: #00ffff; box-shadow: 0 0 15px #00ffff; }
        
        .key::after {
            content: attr(data-key); position: absolute; bottom: 10px; left: 0; width: 100%; text-align: center;
            color: #555; font-size: 0.8rem; font-weight: bold; pointer-events: none;
        }
        .key.black::after { color: #888; bottom: 5px; }

        /* Modal y Player */
        #noteModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: #151515; padding: 30px; border-radius: 10px; width: 300px; border: 1px solid #d400ff; text-align: center; }
        textarea { width: 100%; height: 100px; background: #222; color: white; border: 1px solid #444; margin: 15px 0; border-radius: 5px; padding: 10px; }
        
        #music-player { position: fixed; bottom: 20px; left: 20px; background: rgba(15, 15, 15, 0.95); border: 1px solid #d400ff; padding: 10px 20px; border-radius: 50px; z-index: 1000; display: flex; align-items: center; gap: 15px; box-shadow: 0 0 15px rgba(212, 0, 255, 0.2); }
        .controls button { background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; }
        .song-info { font-size: 0.85rem; max-width: 120px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #d400ff; }

        @media (max-width: 768px) {
            .bottom-section { flex-direction: column; }
            .card, .calendar-section, .piano-section { width: 90%; box-sizing: border-box; }
            .key { width: 40px; } .key.black { width: 30px; margin-left: -15px; }
            #music-player { left: 5%; width: 80%; justify-content: space-between; }
        }
    </style>
</head>
<body>

    <div id="scene-container"></div>
    <p class="instruction">‚ú® Busca "SOFI" en las estrellas ‚ú®</p>

    <div class="bottom-section">
        <div class="card">
            <h2>Hola Sofi</h2>
            <p>Bienvenida a tu universo personal. Arriba, las estrellas esconden tu nombre (gira para encontrarlo).</p>
            <p>Abajo tienes un calendario m√°gico: lo que escribas ah√≠ se guardar√° en la nube y yo podr√© leerlo desde donde est√©.</p>
        </div>
        <div class="card">
            <h2>Instrucciones</h2>
            <p>üéπ <b>Piano:</b> Toca las teclas o usa tu teclado (A, S, D...).</p>
            <p>üìÖ <b>Calendario:</b> Haz clic en un d√≠a para dejarme una nota.</p>
            <p>üéµ <b>M√∫sica:</b> Dale play abajo a la izquierda.</p>
        </div>
    </div>

    <div class="calendar-section">
        <div class="calendar-header">
            <button class="btn-nav" onclick="changeMonth(-1)">‚ùÆ</button>
            <h3 id="monthYear"></h3>
            <button class="btn-nav" onclick="changeMonth(1)">‚ùØ</button>
        </div>
        <div class="days-grid" id="calendarGrid"></div>
    </div>

    <div class="piano-section">
        <h2>üéπ Piano Espacial</h2>
        <div class="piano-keys">
            <div class="key" data-note="C4" data-key="A" onclick="playTone(261.63)"></div>
            <div class="key black" data-note="Cs4" data-key="W" style="left: 45px;" onclick="playTone(277.18)"></div>
            <div class="key" data-note="D4" data-key="S" onclick="playTone(293.66)"></div>
            <div class="key black" data-note="Ds4" data-key="E" style="left: 108px;" onclick="playTone(311.13)"></div>
            <div class="key" data-note="E4" data-key="D" onclick="playTone(329.63)"></div>
            <div class="key" data-note="F4" data-key="F" onclick="playTone(349.23)"></div>
            <div class="key black" data-note="Fs4" data-key="T" style="left: 235px;" onclick="playTone(369.99)"></div>
            <div class="key" data-note="G4" data-key="G" onclick="playTone(392.00)"></div>
            <div class="key black" data-note="Gs4" data-key="Y" style="left: 298px;" onclick="playTone(415.30)"></div>
            <div class="key" data-note="A4" data-key="H" onclick="playTone(440.00)"></div>
            <div class="key black" data-note="As4" data-key="U" style="left: 360px;" onclick="playTone(466.16)"></div>
            <div class="key" data-note="B4" data-key="J" onclick="playTone(493.88)"></div>
            <div class="key" data-note="C5" data-key="K" onclick="playTone(523.25)"></div>
        </div>
    </div>

    <div id="noteModal">
        <div class="modal-content">
            <h3 id="modalDateTitle">Fecha</h3>
            <textarea id="noteText" placeholder="Escribe un mensaje para nosotros..."></textarea>
            <div>
                <button class="btn-nav" onclick="closeModal()">Cerrar</button>
                <button class="btn-nav" style="background:#d400ff; color:white;" onclick="saveNote()">Guardar en la Nube ‚òÅÔ∏è</button>
            </div>
        </div>
    </div>

    <div id="music-player">
        <div class="song-info"><span id="songTitle">Elige canci√≥n...</span></div>
        <div class="controls">
            <button onclick="prevSong()">‚èÆ</button>
            <button onclick="togglePlay()" id="playBtn">‚ñ∂</button>
            <button onclick="nextSong()">‚è≠</button>
        </div>
        <audio id="audioPlayer"></audio>
    </div>

    <script>
        // --- 1. CONFIGURACI√ìN FIREBASE INTEGRADA ---
        const firebaseConfig = {
            apiKey: "AIzaSyCvzZNhb97ABzhKalhPppHwcfUMG5lGVyg",
            authDomain: "regalo-sofi-31bd7.firebaseapp.com",
            databaseURL: "https://regalo-sofi-31bd7-default-rtdb.firebaseio.com",
            projectId: "regalo-sofi-31bd7",
            storageBucket: "regalo-sofi-31bd7.firebasestorage.app",
            messagingSenderId: "896831826087",
            appId: "1:896831826087:web:d9a067f38828a5c1eb1382"
        };
        
        // Inicializar Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();


        // --- 2. L√ìGICA DEL PIANO ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playTone(freq) {
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.type = 'triangle'; 
            osc.frequency.value = freq;
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            osc.start();
            gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 1.5);
            osc.stop(audioCtx.currentTime + 1.5);
        }

        window.addEventListener('keydown', (e) => {
            const keyMap = {
                'a': { freq: 261.63, el: document.querySelector('[data-key="A"]') },
                'w': { freq: 277.18, el: document.querySelector('[data-key="W"]') },
                's': { freq: 293.66, el: document.querySelector('[data-key="S"]') },
                'e': { freq: 311.13, el: document.querySelector('[data-key="E"]') },
                'd': { freq: 329.63, el: document.querySelector('[data-key="D"]') },
                'f': { freq: 349.23, el: document.querySelector('[data-key="F"]') },
                't': { freq: 369.99, el: document.querySelector('[data-key="T"]') },
                'g': { freq: 392.00, el: document.querySelector('[data-key="G"]') },
                'y': { freq: 415.30, el: document.querySelector('[data-key="Y"]') },
                'h': { freq: 440.00, el: document.querySelector('[data-key="H"]') },
                'u': { freq: 466.16, el: document.querySelector('[data-key="U"]') },
                'j': { freq: 493.88, el: document.querySelector('[data-key="J"]') },
                'k': { freq: 523.25, el: document.querySelector('[data-key="K"]') }
            };
            const note = keyMap[e.key.toLowerCase()];
            if (note) {
                playTone(note.freq);
                note.el.classList.add('active');
                setTimeout(() => note.el.classList.remove('active'), 150);
            }
        });


        // --- 3. CALENDARIO CONECTADO A FIREBASE ---
        let currentDate = new Date();
        const monthYearEl = document.getElementById('monthYear');
        const calendarGrid = document.getElementById('calendarGrid');
        const modal = document.getElementById('noteModal');
        const noteText = document.getElementById('noteText');
        let selectedDateKey = null;
        let allNotes = {};

        // Escuchar datos en tiempo real
        const notesRef = database.ref('calendario_notas');
        notesRef.on('value', (snapshot) => {
            allNotes = snapshot.val() || {};
            renderCalendar();
        });

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            monthYearEl.innerText = new Date(year, month).toLocaleString('es-ES', { month: 'long', year: 'numeric' });
            calendarGrid.innerHTML = '';
            
            const weekDays = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
            weekDays.forEach(day => {
                const div = document.createElement('div'); div.className = 'day-name'; div.innerText = day; calendarGrid.appendChild(div);
            });

            const firstDayIndex = new Date(year, month, 1).getDay();
            for(let i=0; i<firstDayIndex; i++) calendarGrid.appendChild(document.createElement('div'));

            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();

            for(let i=1; i<=daysInMonth; i++){
                const dayEl = document.createElement('div'); dayEl.className = 'day-cell'; dayEl.innerText = i;
                const dateKey = `${i}-${month}-${year}`;
                if(i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) dayEl.classList.add('today');
                if(allNotes[dateKey]) dayEl.classList.add('has-note');
                dayEl.onclick = () => openModal(i, month, year);
                calendarGrid.appendChild(dayEl);
            }
        }
        function changeMonth(d) { currentDate.setMonth(currentDate.getMonth() + d); renderCalendar(); }
        function openModal(d, m, y) {
            selectedDateKey = `${d}-${m}-${y}`;
            document.getElementById('modalDateTitle').innerText = `${d}/${m+1}/${y}`;
            noteText.value = allNotes[selectedDateKey] || '';
            modal.style.display = 'flex';
        }
        function closeModal() { modal.style.display = 'none'; }
        
        function saveNote() {
            const val = noteText.value.trim();
            if(val==="") database.ref('calendario_notas/'+selectedDateKey).remove();
            else database.ref('calendario_notas/'+selectedDateKey).set(val);
            closeModal();
        }

        // --- 4. PLAYER DE M√öSICA (Sube tus archivos mp3) ---
        const playlist = [
            { title: "Canci√≥n 1", file: "cancion1.mp3" },
            { title: "Canci√≥n 2", file: "cancion2.mp3" }
        ];
        let currentSongIndex = 0;
        const audioPlayer = document.getElementById('audioPlayer');
        const playBtn = document.getElementById('playBtn');
        const titleLabel = document.getElementById('songTitle');
        let isPlaying = false;

        function loadSong(index) { if(playlist.length) { audioPlayer.src = playlist[index].file; titleLabel.innerText = playlist[index].title; } }
        function togglePlay() {
            if(!playlist.length) return alert("¬°Recuerda subir tus canciones!");
            if(!audioPlayer.src) loadSong(0);
            if(isPlaying) { audioPlayer.pause(); playBtn.innerText="‚ñ∂"; } else { audioPlayer.play(); playBtn.innerText="‚è∏"; }
            isPlaying = !isPlaying;
        }
        function nextSong() { currentSongIndex=(currentSongIndex+1)%playlist.length; loadSong(currentSongIndex); if(isPlaying) audioPlayer.play(); }
        function prevSong() { currentSongIndex=(currentSongIndex-1+playlist.length)%playlist.length; loadSong(currentSongIndex); if(isPlaying) audioPlayer.play(); }

        // --- 5. 3D SOFI (Nombre Escondido) ---
        let camera, scene, renderer, controls, wordGroup;
        const container = document.getElementById('scene-container');
        init(); animate();
        function init() {
            scene = new THREE.Scene(); scene.fog = new THREE.FogExp2(0x000000, 0.0015);
            camera = new THREE.PerspectiveCamera(60, container.clientWidth/container.clientHeight, 0.1, 2000); camera.position.z = 500;
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true }); renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);
            controls = new THREE.OrbitControls(camera, renderer.domElement); controls.enableDamping=true; controls.enableZoom=false;
            const sg = new THREE.BufferGeometry(); const sp = [];
            for(let i=0; i<3000; i++) sp.push(THREE.MathUtils.randFloatSpread(2000), THREE.MathUtils.randFloatSpread(2000), THREE.MathUtils.randFloatSpread(2000));
            sg.setAttribute('position', new THREE.Float32BufferAttribute(sp, 3));
            scene.add(new THREE.Points(sg, new THREE.PointsMaterial({color:0x888888, size:1.5})));
            createSofi();
            window.addEventListener('resize', ()=>{ camera.aspect=container.clientWidth/container.clientHeight; camera.updateProjectionMatrix(); renderer.setSize(container.clientWidth, container.clientHeight); });
        }
        function createSofi() {
            wordGroup = new THREE.Group();
            const ml = new THREE.LineBasicMaterial({color:0xd400ff, opacity:0.8, transparent:true});
            const md = new THREE.PointsMaterial({color:0xffffff, size:4});
            function al(pts, x) {
                const g = new THREE.BufferGeometry().setFromPoints(pts);
                const l = new THREE.Line(g, ml); l.position.x=x;
                const s = new THREE.Points(g, md); s.position.x=x;
                wordGroup.add(l,s);
            }
            const h=40, w=30;
            // S, O, F, I
            al([new THREE.Vector3(w,h,0),new THREE.Vector3(0,h,0),new THREE.Vector3(0,0,0),new THREE.Vector3(w,0,0),new THREE.Vector3(w,-h,0),new THREE.Vector3(0,-h,0)], -80);
            al([new THREE.Vector3(0,h,0),new THREE.Vector3(w,h,0),new THREE.Vector3(w,-h,0),new THREE.Vector3(0,-h,0),new THREE.Vector3(0,h,0)], -30);
            al([new THREE.Vector3(w,h,0),new THREE.Vector3(0,h,0),new THREE.Vector3(0,-h,0)], 20); al([new THREE.Vector3(0,0,0),new THREE.Vector3(w*0.7,0,0)], 20);
            al([new THREE.Vector3(0,h,0),new THREE.Vector3(0,-h,0)], 70);
            
            // Rotaci√≥n Aleatoria
            wordGroup.rotation.set(Math.random()*6, Math.random()*6, Math.random()*6);
            wordGroup.position.set(Math.random()*400-200, Math.random()*400-200, Math.random()*400-200);
            scene.add(wordGroup);
        }
        function animate() { requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); }
    </script>
</body>
</html>
